<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>íƒêµ¬ ë³€í™˜í‘œì¤€ì ìˆ˜ ëŒ€ëŸ‰ í¸ì§‘ê¸°</title>
  <style>
    body { font-family: sans-serif; background: #f4f7f6; margin: 0; padding: 20px; }
    .wrap { max-width: 1100px; margin: 20px auto; background:#fff; padding:24px; border-radius:8px; box-shadow:0 4px 10px rgba(0,0,0,0.08); }
    h1 { margin: 0 0 12px; }
    .row { display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    select, input, textarea, button { font-size:14px; }
    select, input { padding:8px 10px; border:1px solid #ccc; border-radius:6px; }
    textarea { width:100%; min-height:280px; padding:12px; border:1px solid #ccc; border-radius:8px; font-family: ui-monospace, Menlo, Consolas, monospace; }
    button { background:#007bff; color:#fff; border:none; border-radius:6px; padding:10px 14px; font-weight:700; cursor:pointer; }
    button.green { background:#28a745; }
    .msg { margin-top:12px; padding:10px; border-radius:6px; }
    .msg.ok { background:#e6ffed; color:#0f5132; border:1px solid #badbcc; }
    .msg.err{ background:#fdecea; color:#842029; border:1px solid #f5c2c7; }
    .hint { font-size:12px; color:#555; margin-bottom:8px; }
    .split { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    .card { background:#fafafa; padding:12px; border-radius:8px; border:1px solid #eee; }
    .card h3 { margin:0 0 6px; font-size:15px; }
    .small { font-size:12px; color:#666; }
  </style>
</head>
<body>
<div class="wrap">
  <h1>íƒêµ¬ ë³€í™˜í‘œì¤€ì ìˆ˜ ëŒ€ëŸ‰ í¸ì§‘ê¸°</h1>

  <div class="row">
    <label>í•™ë…„ë„
      <select id="year">
        <option value="2026">2026</option>
        <option value="2027">2027</option>
      </select>
    </label>

    <label>í•™êµ
      <select id="school-select" style="min-width:260px">
        <option value="">í•™ë…„ë„ë¥¼ ë¨¼ì € ì„ íƒí•˜ê±°ë‚˜ ì ì‹œë§Œâ€¦</option>
      </select>
    </label>

    <label>í•™ê³¼
      <select id="dept-select" style="min-width:320px">
        <option value="">í•™êµë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option>
      </select>
    </label>

    <button id="btn-load-list">í•™êµ ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
    <button id="btn-load" title="í˜„ì¬ ì €ì¥ëœ ë³€í™˜í‘œì¤€ì ìˆ˜ ë¯¸ë¦¬ë³´ê¸°">ë¶ˆëŸ¬ì˜¤ê¸°</button>
    <button id="btn-save" class="green">ì €ì¥</button>
  </div>

  <div class="hint">
    ì—‘ì…€ì—ì„œ <b>â€œë°±ë¶„ìœ„ / ì‚¬íƒ / ê³¼íƒâ€</b> 3ì—´ì„ ê·¸ëŒ€ë¡œ ë³µì‚¬í•´ì„œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.<br>
    ì˜ˆì‹œ:<br>
    <code>ë°±ë¶„ìœ„	ì‚¬íƒ	ê³¼íƒ<br>100	69.89	70.13<br>99	68.81	69.38</code>
  </div>

  <div class="split">
    <div class="card">
      <h3>ë¶™ì—¬ë„£ê¸° (ì…ë ¥)</h3>
      <textarea id="bulk-text" placeholder="ì—‘ì…€ì—ì„œ ë°±ë¶„ìœ„ / ì‚¬íƒ / ê³¼íƒ ì—´ì„ ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”."></textarea>
      <div class="small">ì €ì¥ ì„±ê³µ ì‹œ ì´ ì…ë ¥ì¹¸ì€ ìë™ìœ¼ë¡œ ë¹„ì›Œì§‘ë‹ˆë‹¤.</div>
    </div>

    <div class="card">
      <h3>í˜„ì¬ ì €ì¥ ë‚´ìš© (ë¯¸ë¦¬ë³´ê¸°)</h3>
      <textarea id="preview" readonly placeholder="ë¶ˆëŸ¬ì˜¤ê¸°ë¥¼ ëˆ„ë¥´ë©´ ì´ê³³ì— í˜„ì¬ ì €ì¥ëœ ë³€í‘œê°€ í‘œì‹œë©ë‹ˆë‹¤."></textarea>
    </div>
  </div>

  <div id="msg" class="msg" style="display:none;"></div>
</div>

<script>
const SVR = 'https://supermax.kr';
const getToken = () => localStorage.getItem('jwt_token');

const yearEl   = document.getElementById('year');
const schoolEl = document.getElementById('school-select');
const deptEl   = document.getElementById('dept-select');
const bulkEl   = document.getElementById('bulk-text');
const prevEl   = document.getElementById('preview');
const msgEl    = document.getElementById('msg');

let schoolData = []; // [{U_ID, ëŒ€í•™ëª…, í•™ê³¼ëª…}, ...]
let schoolsByUniversity = new Map(); // ëŒ€í•™ëª… -> [rows]

function showMsg(ok, text){
  msgEl.style.display='block';
  msgEl.className = 'msg ' + (ok ? 'ok':'err');
  msgEl.textContent = text;
}

async function fetchSchools(){
  const year = yearEl.value;
  try{
    schoolEl.innerHTML = `<option value="">ë¡œë”©ì¤‘â€¦</option>`;
    deptEl.innerHTML = `<option value="">í•™êµë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option>`;

    const res = await fetch(`${SVR}/jungsi/schools/${year}`, {
      headers: {'Authorization': `Bearer ${getToken()}`}
    });
    const data = await res.json();

    // ğŸ”¥ ì—¬ê¸°ì„œ ë°©ì–´ì½”ë“œ: schools ì—†ìœ¼ë©´ list ì“°ê¸°
    const rows =
      Array.isArray(data.schools) ? data.schools :
      Array.isArray(data.list)    ? data.list    :
      [];

    if (!rows.length) {
      showMsg(false, 'í•™êµ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (0ê±´)');
      schoolEl.innerHTML = `<option value="">ë°ì´í„° ì—†ìŒ</option>`;
      return;
    }

    // í•„ìš”í•œ í•„ë“œë§Œ ì¶”ë¦¼ (APIë§ˆë‹¤ í‚¤ê°€ ë‹¤ë¥¼ ìˆ˜ ìˆìœ¼ë‹ˆê¹Œ fallback)
    schoolData = rows.map(r => ({
      U_ID: r.U_ID,
      ëŒ€í•™ëª…: r.ëŒ€í•™ëª… || r.university || r.univ_name || r.univ || '',
      í•™ê³¼ëª…: r.í•™ê³¼ëª… || r.department || r.major || r.dept_name || ''
    }));

    // ëŒ€í•™ëª… ê¸°ì¤€ ê·¸ë£¹
    schoolsByUniversity = new Map();
    for (const row of schoolData) {
      const uniName = row.ëŒ€í•™ëª… || '(ëŒ€í•™ëª… ì—†ìŒ)';
      if (!schoolsByUniversity.has(uniName)) schoolsByUniversity.set(uniName, []);
      schoolsByUniversity.get(uniName).push(row);
    }

    // ëŒ€í•™ëª… ì…€ë ‰íŠ¸ ì±„ìš°ê¸°
    const unis = Array.from(schoolsByUniversity.keys()).sort((a,b)=>a.localeCompare(b,'ko'));
    schoolEl.innerHTML = `<option value="">í•™êµ ì„ íƒ</option>` + unis.map(u=>`<option value="${u}">${u}</option>`).join('');

    showMsg(true, `[${year}] í•™êµ ëª©ë¡ ${schoolData.length}ê±´ ë¶ˆëŸ¬ì˜´`);
  }catch(e){
    console.error(e);
    showMsg(false, 'ì„œë²„ í†µì‹  ì˜¤ë¥˜(í•™êµ ëª©ë¡)');
  }
}

function onUniversityChange(){
  const uni = schoolEl.value;
  prevEl.value = ''; // í•™êµ/í•™ê³¼ ë°”ê¾¸ë©´ ë¯¸ë¦¬ë³´ê¸° ì´ˆê¸°í™”
  if (!uni){
    deptEl.innerHTML = `<option value="">í•™êµë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option>`;
    return;
  }
  const rows = (schoolsByUniversity.get(uni) || []).slice().sort((a,b)=>a.í•™ê³¼ëª….localeCompare(b.í•™ê³¼ëª…,'ko'));
  deptEl.innerHTML = `<option value="">í•™ê³¼ ì„ íƒ</option>` + rows.map(r=>`<option value="${r.U_ID}">${r.í•™ê³¼ëª…}</option>`).join('');
}

async function loadConvPreview(){
  const year = yearEl.value;
  const U_ID = deptEl.value;
  if (!U_ID){ showMsg(false, 'í•™ê³¼ë¥¼ ì„ íƒí•˜ì„¸ìš”.'); return; }
  prevEl.value = 'ë¡œë”©ì¤‘â€¦';
  try{
    const res = await fetch(`${SVR}/jungsi/inquiry-conv/${U_ID}/${year}`, {
      headers: {'Authorization': `Bearer ${getToken()}`}
    });
    const data = await res.json();
    if (!data.success){ showMsg(false, data.message || 'ë¯¸ë¦¬ë³´ê¸° ë¡œë“œ ì‹¤íŒ¨'); prevEl.value=''; return; }

    let out = '';
    for (const kind of ['ì‚¬íƒ','ê³¼íƒ']){
      const m = data.mappings?.[kind] || {};
      const keys = Object.keys(m).map(k=>parseInt(k,10)).filter(n=>!isNaN(n)).sort((a,b)=>b-a);
      if (!keys.length) continue;
      out += `# ${kind}\n`;
      for (const p of keys){ out += `${kind}\t${p}\t${m[String(p)]}\n`; }
      out += '\n';
    }
    prevEl.value = out || '(ì €ì¥ëœ ë³€í‘œê°€ ì—†ìŠµë‹ˆë‹¤)';
    showMsg(true, 'ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ');
  }catch(e){
    console.error(e);
    showMsg(false, 'ì„œë²„ í†µì‹  ì˜¤ë¥˜(ë¯¸ë¦¬ë³´ê¸°)');
  }
}

async function saveData(){
  const year = yearEl.value;
  const U_ID = deptEl.value;
  if (!U_ID){ showMsg(false, 'í•™ê³¼ë¥¼ ì„ íƒí•˜ì„¸ìš”.'); return; }

  const raw = bulkEl.value.trim();
  if (!raw){ showMsg(false, 'ë¶™ì—¬ë„£ì„ ë°ì´í„°ê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤.'); return; }

  const lines = raw.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  const outLines = [];
  for (const line of lines) {
    const parts = line.split(/\t|,|\s+/).filter(Boolean);
    if (!parts.length) continue;
    if (parts[0] === 'ë°±ë¶„ìœ„') continue; // í—¤ë” ìŠ¤í‚µ
    if (parts.length < 3) continue;

    const pct   = parts[0];
    const satam = parts[1];
    const gatam = parts[2];

    if (!isNaN(Number(satam))) outLines.push(`ì‚¬íƒ\t${pct}\t${satam}`);
    if (!isNaN(Number(gatam))) outLines.push(`ê³¼íƒ\t${pct}\t${gatam}`);
  }
  const convertedText = outLines.join('\n');
  if (!convertedText){ showMsg(false, 'ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. (ì—´ ìˆ˜/ìˆ«ì í™•ì¸)'); return; }

  try{
    const res = await fetch(`${SVR}/jungsi/inquiry-conv/bulk-save`,{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':`Bearer ${getToken()}`},
      body: JSON.stringify({ year, U_ID, rows_text: convertedText })
    });
    const data = await res.json();
    const ok = !!data.success;
    showMsg(ok, data.message || (ok?'ì €ì¥ ì„±ê³µ':'ì €ì¥ ì‹¤íŒ¨'));

    if (ok){
      bulkEl.value = '';
      await loadConvPreview();
    }
  }catch(e){
    console.error(e);
    showMsg(false, 'ì„œë²„ í†µì‹  ì˜¤ë¥˜(ì €ì¥)');
  }
}

document.getElementById('btn-load-list').addEventListener('click', fetchSchools);
schoolEl.addEventListener('change', onUniversityChange);
yearEl.addEventListener('change', fetchSchools);
document.getElementById('btn-load').addEventListener('click', loadConvPreview);
document.getElementById('btn-save').addEventListener('click', saveData);

if (!getToken()) {
  alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. /setting ì—ì„œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
}
fetchSchools();
</script>
</body>
</html>
