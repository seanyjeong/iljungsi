<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>í•™êµë³„ ì‹¤ì œì§€ì› í˜„í™©</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-dark: #1d4ed8;
            --light-bg: #f8fafc;
            --card-bg: #ffffff;
            --border-color: #e2e8f0;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --danger-color: #ef4444;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--light-bg);
            padding: 20px;
            margin: 0;
            line-height: 1.5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: var(--card-bg);
            padding: 20px 24px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .header h1 {
            font-size: 1.8rem;
            color: #dc2626;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-controls {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--light-bg);
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .chip label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        select {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: #fff;
            font-size: 0.95rem;
            min-width: 200px;
            cursor: pointer;
        }

        /* Stats Bar */
        .stats-bar {
            background: var(--card-bg);
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            display: flex;
            gap: 30px;
            align-items: center;
            flex-wrap: wrap;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .stat-item .label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .stat-item .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .stat-item .value.quota {
            color: #7c3aed;
            background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);
            padding: 4px 12px;
            border-radius: 8px;
            border: 2px solid #a78bfa;
        }

        .stat-item .value.competition-low {
            color: #059669;
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            padding: 4px 12px;
            border-radius: 8px;
            border: 2px solid #34d399;
        }

        .stat-item .value.competition-normal {
            color: #2563eb;
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            padding: 4px 12px;
            border-radius: 8px;
            border: 2px solid #60a5fa;
        }

        .stat-item .value.competition-high {
            color: #d97706;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            padding: 4px 12px;
            border-radius: 8px;
            border: 2px solid #fbbf24;
        }

        .stat-item .value.competition-extreme {
            color: #dc2626;
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            padding: 4px 12px;
            border-radius: 8px;
            border: 2px solid #f87171;
            animation: pulse-red 2s infinite;
        }

        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(220, 38, 38, 0); }
        }

        /* Applicants Grid */
        .applicants-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .applicant-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .applicant-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px -2px rgba(0, 0, 0, 0.15);
        }

        .applicant-card.my-branch {
            background: linear-gradient(to right, #fffbeb 0%, #ffffff 100%);
            border: 2px solid #f59e0b;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
        }

        .applicant-card.my-branch .card-header {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .applicant-card.my-branch .card-header .branch {
            font-weight: 700;
            opacity: 1;
        }

        /* ìµœì¢…í•©ê²© ìŠ¤íƒ€ì¼ */
        .applicant-card.final-pass {
            background: linear-gradient(to right, #dcfce7 0%, #f0fdf4 100%);
            border: 2px solid #22c55e;
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.15);
        }

        .applicant-card.final-pass .card-header {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        }

        .applicant-card.final-pass .card-header .rank::before {
            content: 'ğŸ‰ ';
        }

        .card-header {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            padding: 10px 16px;
            color: white;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.95rem;
        }

        .card-header .rank {
            font-weight: 700;
            font-size: 1.1rem;
            min-width: 40px;
        }

        .card-header .name {
            font-weight: 700;
            font-size: 1.05rem;
        }

        .card-header .branch {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .card-header .school {
            opacity: 0.85;
            font-size: 0.85rem;
            margin-left: auto;
        }

        .card-body {
            padding: 12px 16px;
            font-size: 0.85rem;
            line-height: 1.6;
        }

        .compact-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
            flex-wrap: wrap;
        }

        .compact-row .label {
            font-weight: 600;
            color: var(--text-secondary);
            min-width: 50px;
        }

        .compact-row .content {
            color: var(--text-primary);
            flex: 1;
        }

        .score-item {
            display: inline-block;
            margin-right: 12px;
            white-space: nowrap;
        }

        .score-item:last-child {
            margin-right: 0;
        }

        .total-row {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 16px;
            font-weight: 600;
        }

        .total-row .item {
            flex: 1;
        }

        .total-row .label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            display: block;
        }

        .total-row .value {
            font-size: 1.05rem;
            color: var(--primary-color);
        }

        .total-row .value.highlight {
            font-size: 1.2rem;
            font-weight: 700;
        }

        /* ê²°ê³¼ ë±ƒì§€ */
        .result-badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed var(--border-color);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .badge-pass {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #86efac;
        }

        .badge-fail {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .badge-wait {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }

        .badge-registered {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }

        /* Grade Text */
        .grade-text {
            font-weight: 600;
        }

        .grade-1, .grade-2 { color: #166534; }
        .grade-3, .grade-4 { color: #1e40af; }
        .grade-5, .grade-6 { color: #92400e; }
        .grade-7, .grade-8, .grade-9 { color: #991b1b; }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .empty-state i {
            font-size: 4rem;
            color: var(--border-color);
            margin-bottom: 20px;
        }

        .empty-state h3 {
            font-size: 1.3rem;
            color: var(--text-secondary);
            margin: 0 0 8px 0;
        }

        .empty-state p {
            font-size: 0.95rem;
            color: var(--text-secondary);
            margin: 0;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.1rem;
            color: var(--text-secondary);
        }

        .loading i {
            font-size: 2rem;
            color: var(--primary-color);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Excel Download Button */
        .btn-excel {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-excel:hover {
            background: linear-gradient(135deg, #047857 0%, #065f46 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
        }
        .btn-excel:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Progress overlay */
        .progress-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        .progress-overlay.show { display: flex; }
        .progress-box {
            background: white;
            padding: 30px 40px;
            border-radius: 16px;
            text-align: center;
            min-width: 320px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .progress-box h3 { margin: 0 0 16px 0; color: var(--text-primary); }
        .progress-bar-wrap {
            background: #e5e7eb;
            border-radius: 8px;
            height: 12px;
            overflow: hidden;
            margin-bottom: 12px;
        }
        .progress-bar-fill {
            background: linear-gradient(90deg, #059669, #10b981);
            height: 100%;
            width: 0%;
            transition: width 0.3s;
            border-radius: 8px;
        }
        .progress-text {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .applicants-grid {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                align-items: stretch;
            }

            .header h1 {
                font-size: 1.4rem;
            }

            .stats-bar {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>
                <i class="fas fa-file-signature"></i>
                í•™êµë³„ ì‹¤ì œì§€ì› í˜„í™©
            </h1>
            <div class="header-controls">
                <div class="chip">
                    <label for="year-select">ì—°ë„</label>
                    <select id="year-select">
                        <option value="2026">2026í•™ë…„ë„</option>
                        <option value="2025">2025í•™ë…„ë„</option>
                    </select>
                </div>
                <div class="chip">
                    <label for="gun-select">
                        <i class="fas fa-flag"></i>
                        ëª¨ì§‘êµ°
                    </label>
                    <select id="gun-select">
                        <option value="">ëª¨ì§‘êµ°ì„ ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="ê°€">ê°€êµ°</option>
                        <option value="ë‚˜">ë‚˜êµ°</option>
                        <option value="ë‹¤">ë‹¤êµ°</option>
                    </select>
                </div>
                <div class="chip">
                    <label for="university-select">
                        <i class="fas fa-school"></i>
                        ëŒ€í•™ ì„ íƒ
                    </label>
                    <select id="university-select" disabled>
                        <option value="">ë¨¼ì € ëª¨ì§‘êµ°ì„ ì„ íƒí•˜ì„¸ìš”</option>
                    </select>
                </div>
                <button class="btn-excel" id="btn-download-all" onclick="downloadAllExcel()">
                    <i class="fas fa-file-excel"></i> ì „ì²´ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                </button>
            </div>
        </div>

        <!-- Stats Bar -->
        <div class="stats-bar" id="stats-bar" style="display: none;">
            <div class="stat-item">
                <div class="label">ëª¨ì§‘ì¸ì›</div>
                <div class="value" id="quota-count">0ëª…</div>
            </div>
            <div class="stat-item">
                <div class="label">ì‹¤ì œ ì§€ì›ì</div>
                <div class="value" id="total-applicants">0ëª…</div>
            </div>
        </div>

        <!-- Applicants Grid -->
        <div id="applicants-container">
            <div class="empty-state">
                <i class="fas fa-flag"></i>
                <h3>ëª¨ì§‘êµ°ì„ ì„ íƒí•´ì£¼ì„¸ìš”</h3>
                <p>ë¨¼ì € ëª¨ì§‘êµ°ì„ ì„ íƒí•œ í›„ ëŒ€í•™ì„ ì„ íƒí•˜ë©´ í•´ë‹¹ í•™êµ ì‹¤ì œì§€ì›ì ëª©ë¡ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
        </div>
    </div>

    <!-- Progress Overlay -->
    <div class="progress-overlay" id="progress-overlay">
        <div class="progress-box">
            <h3><i class="fas fa-file-excel" style="color:#059669"></i> ì—‘ì…€ ìƒì„± ì¤‘...</h3>
            <div class="progress-bar-wrap">
                <div class="progress-bar-fill" id="progress-bar-fill"></div>
            </div>
            <div class="progress-text" id="progress-text">ì¤€ë¹„ ì¤‘...</div>
        </div>
    </div>

    <script>
        const SVR_JUNGSI = 'https://supermax.kr';
        const LOGIN_PAGE = 'jungsilogin.html';

        let currentApplicants = [];
        let currentStats = {};

        function getToken() {
            return localStorage.getItem('jwt_token');
        }

        function getBranchFromToken() {
            const token = getToken();
            if (!token) return null;
            try {
                const payloadBase64Url = token.split('.')[1];
                const payloadBase64 = payloadBase64Url.replace(/-/g, '+').replace(/_/g, '/');
                const binaryString = atob(payloadBase64);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                const decodedString = new TextDecoder().decode(bytes);
                const decoded = JSON.parse(decodedString);
                return decoded.branch || null;
            } catch (e) {
                console.error('í† í° íŒŒì‹± ì‹¤íŒ¨:', e);
                return null;
            }
        }

        async function loadUniversityList(year, gun) {
            const token = getToken();
            if (!token) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = LOGIN_PAGE;
                return;
            }

            if (!gun) {
                const universitySelect = document.getElementById('university-select');
                universitySelect.disabled = true;
                universitySelect.innerHTML = '<option value="">ë¨¼ì € ëª¨ì§‘êµ°ì„ ì„ íƒí•˜ì„¸ìš”</option>';
                return;
            }

            try {
                const res = await fetch(`${SVR_JUNGSI}/jungsi/schools/${year}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) {
                    throw new Error('ëŒ€í•™ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }

                const data = await res.json();
                const universitySelect = document.getElementById('university-select');
                universitySelect.innerHTML = '<option value="">ëŒ€í•™ì„ ì„ íƒí•˜ì„¸ìš”</option>';

                if (data.success && Array.isArray(data.list)) {
                    const filteredSchools = data.list.filter(uni => uni.gun === gun);

                    if (filteredSchools.length === 0) {
                        universitySelect.innerHTML = '<option value="">í•´ë‹¹ ëª¨ì§‘êµ°ì— ëŒ€í•™ì´ ì—†ìŠµë‹ˆë‹¤</option>';
                        universitySelect.disabled = true;
                        return;
                    }

                    filteredSchools.forEach(uni => {
                        const option = document.createElement('option');
                        option.value = uni.U_ID;
                        option.textContent = `${uni.university} - ${uni.department}`;
                        option.dataset.universityName = uni.university;
                        option.dataset.major = uni.department;
                        universitySelect.appendChild(option);
                    });

                    universitySelect.disabled = false;
                }
            } catch (error) {
                console.error('ëŒ€í•™ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('ëŒ€í•™ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        async function loadApplicantsForUniversity(U_ID, year) {
            const token = getToken();

            if (!token) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = LOGIN_PAGE;
                return;
            }

            const container = document.getElementById('applicants-container');
            container.innerHTML = '<div class="loading"><i class="fas fa-spinner"></i><br>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

            try {
                // ì‹¤ì œì§€ì›ì •ë³´ API í˜¸ì¶œ
                const res = await fetch(`${SVR_JUNGSI}/jungsi/university-final-applicants/${U_ID}/${year}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) {
                    throw new Error('ì§€ì›ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }

                const data = await res.json();

                if (data.success) {
                    displayApplicants(data.applicants, data.stats, data.university);
                } else {
                    throw new Error(data.message || 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }

            } catch (error) {
                console.error('ì§€ì›ì ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</h3>
                        <p>${error.message}</p>
                    </div>
                `;
                document.getElementById('stats-bar').style.display = 'none';
            }
        }

        function displayApplicants(applicants, stats, university) {
            const container = document.getElementById('applicants-container');
            const statsBar = document.getElementById('stats-bar');

            currentApplicants = applicants || [];
            currentStats = stats || {};
            const quota = university?.quota || 0;

            if (!applicants || applicants.length === 0) {
                statsBar.style.display = 'none';
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <h3>ì‹¤ì œ ì§€ì›ìê°€ ì—†ìŠµë‹ˆë‹¤</h3>
                        <p>í•´ë‹¹ ëŒ€í•™ì— ì‹¤ì œë¡œ ì§€ì›í•œ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
                return;
            }

            statsBar.style.display = 'flex';

            // ëª¨ì§‘ì¸ì›
            const quotaEl = document.getElementById('quota-count');
            quotaEl.textContent = `${quota}ëª…`;
            quotaEl.className = 'value quota';

            // ì´ì§€ì›ì - ê²½ìŸë¥ ì— ë”°ë¼ ìƒ‰ìƒ ë³€ê²½
            const totalEl = document.getElementById('total-applicants');
            const totalCount = stats.total_count || 0;
            totalEl.textContent = `${totalCount}ëª…`;

            let competitionClass = 'value';
            if (quota > 0) {
                const ratio = totalCount / quota;
                if (ratio < 1) {
                    competitionClass = 'value competition-low';
                } else if (ratio < 2) {
                    competitionClass = 'value competition-normal';
                } else if (ratio < 3) {
                    competitionClass = 'value competition-high';
                } else {
                    competitionClass = 'value competition-extreme';
                }
            }
            totalEl.className = competitionClass;

            renderApplicantCards(applicants);
        }

        function getResultBadge(result, type) {
            if (!result) return '';

            let badgeClass = 'badge-wait';
            let icon = 'fas fa-clock';

            if (result === 'í•©ê²©' || result === 'ë“±ë¡') {
                badgeClass = 'badge-pass';
                icon = 'fas fa-check-circle';
            } else if (result === 'ë¶ˆí•©ê²©') {
                badgeClass = 'badge-fail';
                icon = 'fas fa-times-circle';
            } else if (result.includes('ì˜ˆë¹„')) {
                badgeClass = 'badge-wait';
                icon = 'fas fa-hourglass-half';
            }

            return `<span class="badge ${badgeClass}"><i class="${icon}"></i> ${type}: ${result}</span>`;
        }

        function renderApplicantCards(applicants) {
            const container = document.getElementById('applicants-container');
            const myBranch = getBranchFromToken();

            const cardsHTML = applicants.map((applicant, index) => {
                const rank = index + 1;
                const isMyBranch = myBranch && applicant.branch === myBranch;
                const isFinalPass = applicant.result_final === 'í•©ê²©';

                // ìˆ˜ëŠ¥ ì„±ì  í…ìŠ¤íŠ¸
                const suneungScores = [
                    `êµ­ì–´ í‘œ${applicant.korean_standard || '-'} ë°±${applicant.korean_percentile || '-'} <span class="grade-text grade-${applicant.korean_grade || '9'}">ë“±${applicant.korean_grade || '-'}</span>`,
                    `ìˆ˜í•™ í‘œ${applicant.math_standard || '-'} ë°±${applicant.math_percentile || '-'} <span class="grade-text grade-${applicant.math_grade || '9'}">ë“±${applicant.math_grade || '-'}</span>`,
                    `ì˜ì–´ <span class="grade-text grade-${applicant.english_grade || '9'}">ë“±${applicant.english_grade || '-'}</span>`,
                    `íƒêµ¬1 í‘œ${applicant.inquiry1_standard || '-'} ë°±${applicant.inquiry1_percentile || '-'} <span class="grade-text grade-${applicant.inquiry1_grade || '9'}">ë“±${applicant.inquiry1_grade || '-'}</span>`,
                    `íƒêµ¬2 í‘œ${applicant.inquiry2_standard || '-'} ë°±${applicant.inquiry2_percentile || '-'} <span class="grade-text grade-${applicant.inquiry2_grade || '9'}">ë“±${applicant.inquiry2_grade || '-'}</span>`
                ].map(s => `<span class="score-item">${s}</span>`).join('');

                // ì‹¤ê¸° ê¸°ë¡ í…ìŠ¤íŠ¸
                let practicalText = '-';
                if (applicant.practical_records && typeof applicant.practical_records === 'object' && Object.keys(applicant.practical_records).length > 0) {
                    practicalText = Object.entries(applicant.practical_records)
                        .map(([ì¢…ëª©ëª…, ê¸°ë¡]) => `${ì¢…ëª©ëª…} ${ê¸°ë¡}`)
                        .join(', ');
                }

                // ê²°ê³¼ ë±ƒì§€
                let resultBadges = '';
                if (applicant.result_1st || applicant.result_first || applicant.result_final || applicant.registered) {
                    resultBadges = '<div class="result-badges">';
                    if (applicant.result_1st) {
                        resultBadges += getResultBadge(applicant.result_1st, '1ë‹¨ê³„');
                    }
                    if (applicant.result_first) {
                        resultBadges += getResultBadge(applicant.result_first, 'ìµœì´ˆ');
                    }
                    if (applicant.result_final) {
                        resultBadges += getResultBadge(applicant.result_final, 'ìµœì¢…');
                    }
                    if (applicant.registered === 'Y' || applicant.registered === true) {
                        resultBadges += '<span class="badge badge-registered"><i class="fas fa-star"></i> ë“±ë¡ì™„ë£Œ</span>';
                    }
                    resultBadges += '</div>';
                }

                return `
                    <div class="applicant-card ${isMyBranch ? 'my-branch' : ''} ${isFinalPass ? 'final-pass' : ''}">
                        <div class="card-header">
                            <span class="rank">#${rank}</span>
                            <span class="name">${applicant.name || '-'}</span>
                            <span class="branch">| ${applicant.branch || '-'}</span>
                            <span class="school">${applicant.school_name || '-'}</span>
                        </div>
                        <div class="card-body">
                            <div class="compact-row">
                                <span class="label">ìˆ˜ëŠ¥</span>
                                <span class="content">${suneungScores}</span>
                            </div>
                            ${practicalText !== '-' ? `
                            <div class="compact-row">
                                <span class="label">ì‹¤ê¸°</span>
                                <span class="content">${practicalText}</span>
                            </div>
                            ` : ''}
                            <div class="total-row">
                                <div class="item">
                                    <span class="label">ìˆ˜ëŠ¥ì ìˆ˜</span>
                                    <span class="value">${applicant.suneung_score ? applicant.suneung_score.toFixed(2) : '-'}</span>
                                </div>
                                ${applicant.naeshin_score ? `
                                <div class="item">
                                    <span class="label">ë‚´ì‹ </span>
                                    <span class="value">${applicant.naeshin_score.toFixed(2)}</span>
                                </div>
                                ` : ''}
                                ${applicant.practical_score ? `
                                <div class="item">
                                    <span class="label">ì‹¤ê¸°</span>
                                    <span class="value">${applicant.practical_score.toFixed(2)}</span>
                                </div>
                                ` : ''}
                                <div class="item">
                                    <span class="label">ì´ì </span>
                                    <span class="value highlight">${applicant.total_score ? applicant.total_score.toFixed(2) : '-'}</span>
                                </div>
                            </div>
                            ${resultBadges}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `<div class="applicants-grid">${cardsHTML}</div>`;
        }

        // ========== ì „ì²´ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ==========
        async function downloadAllExcel() {
            const token = getToken();
            if (!token) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }

            const year = document.getElementById('year-select').value;
            const btn = document.getElementById('btn-download-all');
            const overlay = document.getElementById('progress-overlay');
            const barFill = document.getElementById('progress-bar-fill');
            const progressText = document.getElementById('progress-text');

            btn.disabled = true;
            overlay.classList.add('show');
            barFill.style.width = '0%';
            progressText.textContent = 'ëŒ€í•™ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';

            try {
                // 1) ì „ì²´ ëŒ€í•™ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                const res = await fetch(`${SVR_JUNGSI}/jungsi/schools/${year}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error('ëŒ€í•™ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨');
                const data = await res.json();
                if (!data.success || !Array.isArray(data.list)) throw new Error('ëŒ€í•™ ëª©ë¡ ë°ì´í„° ì˜¤ë¥˜');

                const allSchools = data.list;
                const totalCount = allSchools.length;
                progressText.textContent = `ì´ ${totalCount}ê°œ ëŒ€í•™ ë°ì´í„° ìˆ˜ì§‘ ì¤‘...`;

                // 2) ê° ëŒ€í•™ë³„ë¡œ ì§€ì›ì ë°ì´í„° ìˆ˜ì§‘
                const allRows = [];
                let completed = 0;

                for (const school of allSchools) {
                    try {
                        const appRes = await fetch(`${SVR_JUNGSI}/jungsi/university-final-applicants/${school.U_ID}/${year}`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });

                        if (appRes.ok) {
                            const appData = await appRes.json();
                            if (appData.success && Array.isArray(appData.applicants)) {
                                const quota = appData.university?.quota || 0;
                                const applicantCount = appData.applicants.length;

                                appData.applicants.forEach((a, idx) => {
                                    // ì‹¤ê¸° ê¸°ë¡ í…ìŠ¤íŠ¸
                                    let practicalText = '';
                                    if (a.practical_records && typeof a.practical_records === 'object') {
                                        practicalText = Object.entries(a.practical_records)
                                            .map(([ì¢…ëª©, ê¸°ë¡]) => `${ì¢…ëª©} ${ê¸°ë¡}`)
                                            .join(', ');
                                    }

                                    allRows.push({
                                        'ëª¨ì§‘êµ°': school.gun || '',
                                        'ëŒ€í•™': school.university || '',
                                        'í•™ê³¼': school.department || '',
                                        'ëª¨ì§‘ì¸ì›': quota,
                                        'ì´ì§€ì›ì': applicantCount,
                                        'ìˆœìœ„': idx + 1,
                                        'ì´ë¦„': a.name || '',
                                        'ì§€ì ': a.branch || '',
                                        'ì¶œì‹ ê³ êµ': a.school_name || '',
                                        'êµ­ì–´_í‘œì¤€': a.korean_standard || '',
                                        'êµ­ì–´_ë°±ë¶„ìœ„': a.korean_percentile || '',
                                        'êµ­ì–´_ë“±ê¸‰': a.korean_grade || '',
                                        'ìˆ˜í•™_í‘œì¤€': a.math_standard || '',
                                        'ìˆ˜í•™_ë°±ë¶„ìœ„': a.math_percentile || '',
                                        'ìˆ˜í•™_ë“±ê¸‰': a.math_grade || '',
                                        'ì˜ì–´_ë“±ê¸‰': a.english_grade || '',
                                        'íƒêµ¬1_í‘œì¤€': a.inquiry1_standard || '',
                                        'íƒêµ¬1_ë°±ë¶„ìœ„': a.inquiry1_percentile || '',
                                        'íƒêµ¬1_ë“±ê¸‰': a.inquiry1_grade || '',
                                        'íƒêµ¬2_í‘œì¤€': a.inquiry2_standard || '',
                                        'íƒêµ¬2_ë°±ë¶„ìœ„': a.inquiry2_percentile || '',
                                        'íƒêµ¬2_ë“±ê¸‰': a.inquiry2_grade || '',
                                        'ìˆ˜ëŠ¥ì ìˆ˜': a.suneung_score ? a.suneung_score.toFixed(2) : '',
                                        'ë‚´ì‹ ì ìˆ˜': a.naeshin_score ? a.naeshin_score.toFixed(2) : '',
                                        'ì‹¤ê¸°ì ìˆ˜': a.practical_score ? a.practical_score.toFixed(2) : '',
                                        'ì‹¤ê¸°ê¸°ë¡': practicalText,
                                        'ì´ì ': a.total_score ? a.total_score.toFixed(2) : '',
                                        '1ë‹¨ê³„ê²°ê³¼': a.result_1st || '',
                                        'ìµœì´ˆê²°ê³¼': a.result_first || '',
                                        'ìµœì¢…ê²°ê³¼': a.result_final || '',
                                        'ë“±ë¡ì—¬ë¶€': a.registered === 'Y' || a.registered === true ? 'Y' : ''
                                    });
                                });
                            }
                        }
                    } catch (e) {
                        console.warn(`${school.university} ${school.department} ë°ì´í„° ìˆ˜ì§‘ ì‹¤íŒ¨:`, e);
                    }

                    completed++;
                    const pct = Math.round((completed / totalCount) * 100);
                    barFill.style.width = pct + '%';
                    progressText.textContent = `${completed}/${totalCount} ëŒ€í•™ ì™„ë£Œ (${pct}%)`;
                }

                if (allRows.length === 0) {
                    alert('ë‹¤ìš´ë¡œë“œí•  ì§€ì›ì ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    overlay.classList.remove('show');
                    btn.disabled = false;
                    return;
                }

                // 3) ì—‘ì…€ ìƒì„± ë° ë‹¤ìš´ë¡œë“œ
                progressText.textContent = 'ì—‘ì…€ íŒŒì¼ ìƒì„± ì¤‘...';
                barFill.style.width = '100%';

                const ws = XLSX.utils.json_to_sheet(allRows);

                // ì»¬ëŸ¼ ë„ˆë¹„ ìë™ ì¡°ì •
                const colWidths = Object.keys(allRows[0]).map(key => {
                    const maxLen = Math.max(
                        key.length,
                        ...allRows.map(r => String(r[key]).length)
                    );
                    return { wch: Math.min(maxLen + 2, 30) };
                });
                ws['!cols'] = colWidths;

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'ì‹¤ì œì§€ì›í˜„í™©');

                const fileName = `ì‹¤ì œì§€ì›í˜„í™©_ì „ì²´_${year}í•™ë…„ë„_${new Date().toISOString().slice(0,10)}.xlsx`;
                XLSX.writeFile(wb, fileName);

                progressText.textContent = `ì™„ë£Œ! ${allRows.length}ê±´ ë‹¤ìš´ë¡œë“œë¨`;
                setTimeout(() => {
                    overlay.classList.remove('show');
                }, 1500);

            } catch (error) {
                console.error('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                overlay.classList.remove('show');
            } finally {
                btn.disabled = false;
            }
        }

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            const token = getToken();
            if (!token) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = LOGIN_PAGE;
                return;
            }

            const yearSelect = document.getElementById('year-select');
            const gunSelect = document.getElementById('gun-select');
            const universitySelect = document.getElementById('university-select');

            yearSelect.addEventListener('change', () => {
                const selectedGun = gunSelect.value;
                if (selectedGun) {
                    loadUniversityList(yearSelect.value, selectedGun);
                }
            });

            gunSelect.addEventListener('change', () => {
                const selectedGun = gunSelect.value;
                loadUniversityList(yearSelect.value, selectedGun);

                document.getElementById('applicants-container').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-university"></i>
                        <h3>ëŒ€í•™ì„ ì„ íƒí•´ì£¼ì„¸ìš”</h3>
                        <p>ìœ„ì—ì„œ ëŒ€í•™ì„ ì„ íƒí•˜ë©´ í•´ë‹¹ í•™êµ ì‹¤ì œì§€ì›ì ëª©ë¡ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
                document.getElementById('stats-bar').style.display = 'none';
            });

            universitySelect.addEventListener('change', () => {
                const selectedUID = universitySelect.value;
                if (selectedUID) {
                    loadApplicantsForUniversity(selectedUID, yearSelect.value);
                } else {
                    document.getElementById('applicants-container').innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-university"></i>
                            <h3>ëŒ€í•™ì„ ì„ íƒí•´ì£¼ì„¸ìš”</h3>
                            <p>ìœ„ì—ì„œ ëŒ€í•™ì„ ì„ íƒí•˜ë©´ í•´ë‹¹ í•™êµ ì‹¤ì œì§€ì›ì ëª©ë¡ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                        </div>
                    `;
                    document.getElementById('stats-bar').style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>
