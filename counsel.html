<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>정시 개인별 상담 (3.7v)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2563eb; --primary-dark:#1d4ed8;
            --light-bg: #f8fafc; --card-bg: #ffffff;
            --border-color: #e2e8f0; --text-primary:#1e293b; --text-secondary:#475569;
            --danger-color: #ef4444; --success-color: #10b981; --warning-color: #f59e0b;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --info-color: #3b82f6;
        }
        * { box-sizing: border-box; }
        body {
            font-family: 'Pretendard', sans-serif;
            background: var(--light-bg);
            padding: 20px;
            margin: 0;
            line-height: 1.5;
        }
        .container { max-width: 95%; margin: 0 auto; }

        /* ---------- Header (sticky) ---------- */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            gap: 12px; flex-wrap: wrap;
            background: var(--card-bg); padding: 16px 18px; border-radius: 12px; box-shadow: var(--shadow);
            margin-bottom: 12px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header h1 { font-size: 1.6rem; color: var(--primary-color); margin: 0; display: flex; align-items: center; gap: 10px; }
        .header-controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .chip {
            display: inline-flex; align-items: center; gap: 6px;
            background: var(--light-bg); padding: 8px 10px; border-radius: 8px; border: 1px solid var(--border-color);
        }
        .chip label { font-size: .9rem; color: var(--text-secondary); white-space: nowrap; }
        select { padding: 8px 10px; border: 1px solid var(--border-color); border-radius: 6px; background: #fff; font-size: .95rem; min-width: 150px; }
        .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 14px; border: none; border-radius: 8px; font-weight: 600; font-size: .9rem; cursor: pointer; transition: .2s; }
        .btn-primary { background: var(--primary-color); color: #fff; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-primary:disabled { background: #9ca3af; cursor: not-allowed; opacity: 0.7; }
        .btn-outline { background: #fff; color: var(--text-secondary); border:1px solid var(--border-color); }
        .btn-outline:hover { background: #f8fafc; }
        .btn-sm { padding: 4px 8px; font-size: .8rem; }
        .btn-danger { background: var(--danger-color); color: #fff; padding: 6px 8px; border-radius: 6px; }
        .btn-danger:hover { background: #dc2626; }
        .btn-success { background: var(--success-color); color: #fff; }
        .btn-success:hover { background: #059669; }

        /* ---------- Student info (sticky) ---------- */
        #student-info-container {
            padding: 12px 16px;
            background: var(--card-bg);
            border-radius: 10px;
            box-shadow: var(--shadow);
            margin-bottom: 14px;
            position: sticky;
            top: 72px; /* 헤더 아래 */
            z-index: 90;
        }
        .student-basic-info { display: flex; flex-wrap: wrap; gap: 14px; margin-bottom: 8px; font-size: 1.05rem; color: var(--text-primary); }
        .student-basic-info .info-item i { color: var(--text-secondary); margin-right: 5px; }
        .student-scores-info { display: flex; flex-wrap: wrap; gap: 8px 12px; font-size: 1.2rem; color: var(--text-secondary); padding-top: 8px; border-top: 1px dashed var(--border-color); }
        .score-item { background: #f8fafc; padding: 3px 8px; border-radius: 4px; border: 1px solid var(--border-color); }
        .grade-emphasis { font-weight: 700; color: var(--primary-color); font-size: 1.05em; margin: 0 2px; }

        /* ---------- Results area ---------- */
        .results-area {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .gun-section { background: rgba(0,0,0,0.02); border: 1px dashed var(--border-color); border-radius: 8px; padding: 12px; }
        .gun-section h2 { margin: 0 0 12px; font-size: 1.15rem; color: var(--text-primary); border-bottom: 1px solid var(--border-color); padding-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .gun-section h2 .gun-count { font-size: .9rem; color: var(--text-secondary); background: #e2e8f0; padding: 3px 8px; border-radius: 10px; }

        .result-card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 12px; box-shadow: var(--shadow); overflow: hidden; }
        .result-card-header { background: #f8fafc; padding: 8px 12px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        .result-card-header .left { display: inline-flex; align-items: center; gap: 8px; min-width: 0; }
        .result-card-header .right { display: inline-flex; gap: 6px; flex-shrink: 0; flex-direction: column; align-items: flex-end; }
        .result-card-header h3 { margin: 0; font-size: 1rem; font-weight: 700; color: var(--primary-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .result-card-header h3 span { display: block; font-size: .85rem; color: var(--text-secondary); font-weight: 400; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .result-card-body { padding: 12px; }

        /* ⭐️ 카드 상단 메트릭 */
        .top-metrics {
            font-size: .72rem;
            line-height: 1.25;
            text-align: right;
            color: #0f172a;
        }
        .top-metrics .metric { white-space: nowrap; }
        .top-metrics .metric.top10 { font-weight: 600; color: #1d4ed8; }
        .top-metrics .metric.branch { color: #0f766e; }
        .top-metrics .metric.max { color: #b91c1c; }

        .score-breakdown { margin-bottom: 12px; }
        .score-breakdown table { width: 100%; font-size: .9rem; border-collapse: collapse; }
        .score-breakdown th { text-align: left; padding: 4px 0; color: var(--text-secondary); width: 95px; white-space: nowrap; }
        .score-breakdown td { text-align: right; padding: 4px 0; }
        .score-breakdown .total-score td { font-weight: 700; font-size: 1.05rem; color: var(--primary-color); }
        .score-breakdown .naeshin-score-row { display: none; }
        .input-section { margin-top: 10px; padding-top: 10px; border-top: 1px dashed var(--border-color); }
        .input-section table { width: 100%; font-size: .9rem; border-collapse: collapse; }
        .input-section th { text-align: left; padding: 5px 0; color: var(--text-secondary); width: 95px; white-space: nowrap; }
        .input-section td { text-align: right; padding: 5px 0; display: flex; justify-content: flex-end; gap: 8px; align-items: center; }
        .input-section input[type="text"], .input-section input[type="number"] { width: 100px; padding: 6px 8px; border: 1px solid var(--border-color); border-radius: 4px; font-size: .9em; text-align: right; box-sizing: border-box; }
        .practical-score-display { font-size: .85em; color: var(--text-secondary); min-width: 60px; text-align: right; }
        .practical-score-display span { color: var(--danger-color); font-weight: 500; }
        .score-silgi { color: var(--success-color); font-weight: 500; }
        .score-silgi span { color: var(--danger-color); font-weight: 500; margin-left: 4px; }
        .top-10-score-display { display:none; }

        .card-actions { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px; }

        /* ---------- Filter Bar ---------- */
        .filter-bar {
            background: var(--card-bg); padding: 18px; border-radius: 12px;
            box-shadow: var(--shadow); margin-bottom: 18px;
        }
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px 16px;
            align-items: end;
        }
        .filter-group { display: flex; flex-direction: column; gap: 6px; }
        .filter-group label { font-size: .9rem; color: var(--text-secondary); font-weight: 500; display: flex; align-items: center; gap: 5px; }
        .filter-group select, .filter-group input { width: 100%; padding: 8px 10px; border: 1px solid var(--border-color); border-radius: 6px; background: #fff; font-size: .95rem; }
        .filter-group .checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; padding-top: 5px; }
        .filter-group .checkbox-group label { font-size: .95rem; color: var(--text-primary); font-weight: 400; display: flex; align-items: center; gap: 4px; }
        .filter-group .checkbox-group input { width: auto; }
        .filter-bar-actions { grid-column: 1 / -1; display: flex; justify-content: space-between; gap: 10px; margin-top: 10px; align-items: center; flex-wrap: wrap; }
        /* [NEW] left-actions wrapper */
        .filter-bar-actions .left-actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .filter-bar-actions .gun-filter { display: flex; gap: 8px; }
        .filter-bar-actions .gun-filter label {
            padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer;
            font-size: 0.9rem; font-weight: 500; color: var(--text-secondary); background: #fff;
        }
        .filter-bar-actions .gun-filter input { display: none; }
        .filter-bar-actions .gun-filter input:checked + label {
            background: var(--primary-color); color: #fff; border-color: var(--primary-color);
        }
        #filter-count { font-size: .9rem; color: var(--text-secondary); align-self: center; font-weight: 600; }

        /* ⭐️ Custom Multiselect CSS */
        .custom-multiselect { position: relative; width: 100%; }
        .multiselect-display {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 10px; border: 1px solid var(--border-color); border-radius: 6px;
            background: #fff; font-size: .95rem; cursor: pointer;
        }
        .multiselect-display span {
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            color: var(--text-primary);
        }
        .multiselect-display span.placeholder { color: var(--text-secondary); }
        .multiselect-display .fa-chevron-down {
            transition: transform 0.2s;
            color: var(--text-secondary); font-size: 0.8em;
        }
        .custom-multiselect.open .fa-chevron-down { transform: rotate(180deg); }

        .multiselect-dropdown {
            display: none;
            position: absolute;
            top: calc(100% + 4px); left: 0; right: 0;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
        }
        .custom-multiselect.open .multiselect-dropdown { display: block; }
        .multiselect-dropdown label {
            display: block;
            padding: 8px 12px;
            font-size: 0.9rem;
            color: var(--text-primary);
            cursor: pointer;
            display: flex; align-items: center; gap: 8px;
        }
        .multiselect-dropdown label:hover { background: var(--light-bg); }
        .multiselect-dropdown input[type="checkbox"] { width: auto; }

        /* ---------- 필터 결과 테이블 ---------- */
        .filter-results-card {
            background: var(--card-bg); border-radius: 12px; box-shadow: var(--shadow);
            margin-bottom: 18px; padding: 0; overflow: hidden;
        }
        .filter-results-header { padding: 14px 18px; border-bottom: 1px solid var(--border-color); }
        .filter-results-header h2 { margin: 0; font-size: 1.2rem; }
        .filter-results-table-container { max-height: 60vh; overflow-y: auto; }
        .filter-results-table { width: 100%; border-collapse: collapse; font-size: .85rem; table-layout: fixed; }
        .filter-results-table thead th {
            position: sticky; top: 0; background: #f8fafc;
            border-bottom: 1px solid var(--border-color);
            padding: 10px 12px; text-align: left; font-weight: 600;
            white-space: nowrap;
        }
        .filter-results-table tbody tr:hover { background: #f8fafc; }
        .filter-results-table td {
            padding: 10px 12px; border-bottom: 1px solid var(--border-color);
            vertical-align: middle; line-height: 1.4;
        }

        .filter-results-table th:nth-child(1) { width: 15%; }
        .filter-results-table th:nth-child(2) { width: 11%; }
        .filter-results-table th:nth-child(3) { width: 4%; text-align: right; }
        .filter-results-table th:nth-child(4) { width: 4%; text-align: right; }
        .filter-results-table th:nth-child(5) { width: 4%; text-align: right; }
        .filter-results-table th:nth-child(6) { width: 4%; text-align: right; }
        .filter-results-table th:nth-child(7) { width: 18%; }
        .filter-results-table th:nth-child(8) { width: 13%; }
        .filter-results-table th:nth-child(9) { width: 4%; text-align: right; }
        .filter-results-table th:nth-child(10) { width: 7%; text-align: right; }
        .filter-results-table th:nth-child(11) { width: 6%; text-align: right; }
        .filter-results-table th:nth-child(12) { width: 6%; text-align: right; }
        .filter-results-table th:nth-child(13) { width: 7%; }

        .filter-results-table .univ-name { font-weight: 600; color: var(--text-primary); font-size: 1.05em; display: block; }
        .filter-results-table .dept-name { color: var(--text-secondary); }
        .filter-results-table .col-info span {
            display: inline-block; padding: 2px 6px; border-radius: 4px;
            font-size: 0.9em; margin: 2px 2px 2px 0; border: 1px solid;
            white-space: nowrap;
        }
        .filter-results-table .info-gun-가 { background: #fef2f2; border-color: #fecaca; color: #b91c1c; }
        .filter-results-table .info-gun-나 { background: #f0f9ff; border-color: #bae6fd; color: #0369a1; }
        .filter-results-table .info-gun-다 { background: #f0fdf4; border-color: #bbf7d0; color: #15803d; }
        .filter-results-table .info-region { background: #f1f5f9; border-color: #e2e8f0; color: #475569; }
        .filter-results-table .info-teach-O { background: #fefce8; border-color: #fde047; color: #a16207; }
        .filter-results-table .info-teach-T { background: #fefce8; border-color: #fde047; color: #a16207; border-style: dashed; }

        .filter-results-table .col-subjects span {
            display: inline-block; padding: 2px 6px; border-radius: 4px;
            background: #f8fafc; border: 1px solid #e2e8f0; margin: 2px;
            white-space: nowrap; font-size: 0.9em;
        }
        .filter-results-table .col-subjects span.optional { border-style: dashed; }
        .filter-results-table .col-subjects span.empty { color: #94a3b8; }

        .filter-results-table .col-events {
            font-size: 0.9em;
            color: var(--text-secondary);
            white-space: normal;
            word-break: keep-all;
        }
        .filter-results-table td { text-align: left; }
        .filter-results-table .col-score,
        .filter-results-table .col-cut,
        .filter-results-table .col-percent,
        .filter-results-table .col-numeric {
            text-align: right;
            font-size: 0.95em;
            padding-left: 6px;
            padding-right: 6px;
        }
        .filter-results-table .col-score .score-loading { color: var(--text-secondary); font-size: 0.9em; }
        .filter-results-table .col-score .score-high { color: var(--primary-color); font-weight: 700; }
        .filter-results-table .col-score .score-low { color: var(--danger-color); font-weight: 700; }
        .filter-results-table .col-score .score-none { color: var(--text-primary); font-weight: 700; }
        .filter-results-table .col-cut { color: var(--text-secondary); }
        .filter-results-table .col-percent { color: var(--text-secondary); font-weight: 500; }
        .filter-results-table .col-actions { text-align: center; }
        .filter-results-table .btn-add { font-size: 0.8rem; padding: 5px 8px; }

        /* ---------- [NEW] Empty State ---------- */
        .empty-state {
            display: block; /* Will be toggled */
            text-align: center;
            padding: 40px;
            font-size: 1.1rem;
            color: var(--text-secondary);
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow);
            grid-column: 1 / -1; /* Make it span the grid */
        }
        .empty-state i {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #cbd5e1; /* Lighter color */
        }

        /* ---------- Modal ---------- */
        .modal {
            display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.6); padding-top: 60px;
        }
        .modal-content {
            background-color: #fefefe; margin: 3% auto; padding: 20px; border: 1px solid #888;
            width: 85%; max-width: 750px; border-radius: 10px; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            max-height: 85vh; overflow-y: auto;
        }
        .modal-content.large { max-width: 850px; }
        .modal-close {
            color: #aaa; position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; cursor: pointer;
        }
        .modal-close:hover, .modal-close:focus { color: black; text-decoration: none; }
        .modal h2 { margin-top: 0; font-size: 1.3rem; color: var(--primary-color); border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 15px;}
        .modal ul { list-style: none; padding: 0; margin: 10px 0 0; }
        .modal li { padding: 5px 0; border-bottom: 1px solid var(--border-color); font-size: 0.9rem; }
        .modal li:last-child { border-bottom: none; }

        /* 실기배점 모달 전용 */
        .silgi-modal-top {
            display: flex; gap: 10px; align-items: center; margin-bottom: 16px;
        }
        .silgi-modal-top label { font-weight: 600; color: var(--text-secondary); }
        .silgi-modal-top select {
            padding: 6px 10px; border: 1px solid var(--border-color);
            border-radius: 6px; background: #fff;
        }
        .silgi-event-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        .silgi-event-table th,
        .silgi-event-table td {
            border-bottom: 1px solid #e2e8f0;
            padding: 6px 8px;
            text-align: center;
        }
        .silgi-event-table th {
            background: #f8fafc;
        }
        .silgi-event-table caption {
            text-align: left;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text-primary);
        }

        /* 토스트 */
        .toast-popup { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: rgba(0,0,0,0.8); color: white; padding: 10px 18px; border-radius: 20px; font-size: 0.9rem; z-index: 1002; opacity: 0; transition: opacity 0.3s, bottom 0.3s; pointer-events: none; }
        .toast-popup.show { opacity: 1; bottom: 40px; }
        .toast-popup.success { background-color: var(--success-color); }
        .toast-popup.error { background-color: var(--danger-color); }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1><i class="fas fa-user-check"></i> 정시 개인별 상담</h1>
        <div class="header-controls">
            <div class="chip">
                <label for="student-select"><i class="fas fa-user-graduate"></i> 상담 학생</label>
                <select id="student-select"><option value="">- 학생 선택 -</option></select>
            </div>
            <div class="chip">
                <label for="year-select"><i class="fas fa-calendar-alt"></i> 대상 학년도</label>
                <select id="year-select">
                    <option value="2026">2026</option>
                    <option value="2027">2027</option>
                </select>
            </div>
        </div>
    </div>

    <div id="student-info-container" class="card" style="display:none; margin-bottom: 14px;">
        <div class="student-basic-info">
            <span class="info-item"><i class="fas fa-user-circle"></i> <strong id="selected-student-name">학생 이름</strong></span>
            <span class="info-item"><i class="fas fa-school"></i> <span id="selected-school-name">학교 정보</span></span>
            <span class="info-item"><i class="fas fa-venus-mars"></i> <span id="selected-gender">성별</span></span>
        </div>
        <div class="student-scores-info">
            <span class="score-item" id="score-kor">국어(?): -</span>
            <span class="score-item" id="score-math">수학(?): -</span>
            <span class="score-item" id="score-eng">영어: -</span>
            <span class="score-item" id="score-inq1">탐구1(?): -</span>
            <span class="score-item" id="score-inq2">탐구2(?): -</span>
            <span class="score-item" id="score-hist">한국사: -</span>
        </div>
    </div>

    <div class="results-area">
        <div id="empty-state-message" class="empty-state">
            <i class="fas fa-user-plus"></i>
            <p>학생을 먼저 선택해주세요!</p>
        </div>
        
        <div class="gun-section" id="ga-gun" style="display:none;">
            <h2><span class="gun-name">가군</span><span class="gun-count">0 / 3</span></h2>
            <div class="result-cards-container"></div>
        </div>
        <div class="gun-section" id="na-gun" style="display:none;">
            <h2><span class="gun-name">나군</span><span class="gun-count">0 / 3</span></h2>
            <div class="result-cards-container"></div>
        </div>
        <div class="gun-section" id="da-gun" style="display:none;">
            <h2><span class="gun-name">다군</span><span class="gun-count">0 / 3</span></h2>
            <div class="result-cards-container"></div>
        </div>
    </div>

    <div class="filter-bar">
        <div class="filter-grid">
            <div class="filter-group">
                <label for="filter-region-custom"><i class="fas fa-map-marker-alt"></i> 지역</label>
                <div class="custom-multiselect" id="filter-region-custom">
                    <div class="multiselect-display">
                        <span class="placeholder">- 지역 선택 -</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="multiselect-dropdown"></div>
                </div>
            </div>
            <div class="filter-group">
                <label for="filter-teaching"><i class="fas fa-chalkboard-teacher"></i> 교직이수</label>
                <select id="filter-teaching">
                    <option value="">전체</option>
                    <option value="가능">가능 (O, △)</option>
                    <option value="불가">불가 (X)</option>
                </select>
            </div>
            <div class="filter-group">
                <label><i class="fas fa-book-dead"></i> 반영 제외 과목</label>
                <div class="checkbox-group" id="filter-exclude-subject">
                    <label><input type="checkbox" value="국어"> 국어</label>
                    <label><input type="checkbox" value="수학"> 수학</label>
                    <label><input type="checkbox" value="영어"> 영어</label>
                    <label><input type="checkbox" value="탐구"> 탐구</label>
                </div>
            </div>
            <div class="filter-group">
                <label for="filter-inquiry-count"><i class="fas fa-list-ol"></i> 탐구 반영 수</label>
                <select id="filter-inquiry-count">
                    <option value="">전체</option>
                    <option value="1">1개</option>
                    <option value="2">2개</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="filter-exclude-event-custom"><i class="fas fa-running"></i> 실기 제외 종목</label>
                <div class="custom-multiselect" id="filter-exclude-event-custom">
                    <div class="multiselect-display">
                        <span class="placeholder">- 종목 선택 -</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="multiselect-dropdown"></div>
                </div>
            </div>
        </div>
        <div class="filter-bar-actions">
            <div class="left-actions">
                <div class="gun-filter" id="filter-gun">
                    <input type="radio" name="gun-filter" id="gun-all" value="전체" checked>
                    <label for="gun-all">전체</label>
                    <input type="radio" name="gun-filter" id="gun-ga" value="가">
                    <label for="gun-ga">가군</label>
                    <input type="radio" name="gun-filter" id="gun-na" value="나">
                    <label for="gun-na">나군</label>
                    <input type="radio" name="gun-filter" id="gun-da" value="다">
                    <label for="gun-da">다군</label>
                </div>
                <button type="button" id="filter-reset-btn" class="btn btn-outline btn-sm">
                    <i class="fas fa-sync-alt"></i> 필터 초기화
                </button>
            </div>
            <span id="filter-count"></span>
        </div>
    </div>

    <div class="filter-results-card" id="filter-results-container" style="display:none;">
        <div class="filter-results-header">
            <h2>필터 결과</h2>
        </div>
        <div class="filter-results-table-container">
            <table class="filter-results-table">
                <thead>
                <tr>
                    <th>대학/학과</th>
                    <th>군/지역/교직</th>
                    <th>모집인원</th>
                    <th>수능%</th>
                    <th>내신%</th>
                    <th>실기%</th>
                    <th>반영 과목 (원본표)</th>
                    <th>실기종목</th>
                    <th>탐구수</th>
                    <th>학생 환산점수</th>
                    <th>지점컷</th>
                    <th>MAX컷</th>
                    <th>상담목록추가</th>
                </tr>
                </thead>
                <tbody id="filter-results-body"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="cross-gun-modal" class="modal">
    <div class="modal-content">
        <span class="modal-close" onclick="closeModal('cross-gun-modal')">&times;</span>
        <h2 id="cross-gun-modal-title">타군 인기 지원 현황</h2>
        <div id="cross-gun-modal-body"></div>
    </div>
</div>

<div id="score-table-modal" class="modal">
    <div class="modal-content large">
        <span class="modal-close" onclick="closeModal('score-table-modal')">&times;</span>
        <h2 id="score-table-modal-title">배점표</h2>
        <div id="score-table-modal-body"></div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const SVR_JUNGSI = 'https://supermax.kr';
    const LOGIN_PAGE = 'jungsilogin.html';

    const yearSelect = document.getElementById('year-select');
    const studentSelect = document.getElementById('student-select');

    const filterTeaching = document.getElementById('filter-teaching');
    const filterExcludeSubject = document.getElementById('filter-exclude-subject');
    const filterInquiryCount = document.getElementById('filter-inquiry-count');
    const filterGun = document.getElementById('filter-gun');
    const filterCount = document.getElementById('filter-count');
    const filterResultsContainer = document.getElementById('filter-results-container');
    const filterResultsBody = document.getElementById('filter-results-body');
    const filterRegionCustom = document.getElementById('filter-region-custom');
    const filterExcludeEventCustom = document.getElementById('filter-exclude-event-custom');
    const filterResetBtn = document.getElementById('filter-reset-btn'); // [NEW] Reset button

    const scoreTableModal = document.getElementById('score-table-modal');
    const scoreTableModalTitle = document.getElementById('score-table-modal-title');
    const scoreTableModalBody = document.getElementById('score-table-modal-body');

    const crossGunModal = document.getElementById('cross-gun-modal');
    const crossGunModalBody = document.getElementById('cross-gun-modal-body');
    const crossGunModalTitle = document.getElementById('cross-gun-modal-title');
    
    // [MODIFIED] 군(전체/가/나/다) 라디오 눌렀을 때 다시 렌더
    filterGun.addEventListener('change', () => {
        renderFilteredResults();
    });
    
    // [NEW] Add live filtering for other filters
    filterTeaching.addEventListener('change', renderFilteredResults);
    filterExcludeSubject.addEventListener('change', renderFilteredResults);
    filterInquiryCount.addEventListener('change', renderFilteredResults);

    // [NEW] Filter Reset Function
    function resetFilters() {
        // 1. Reset simple selects
        filterTeaching.value = "";
        filterInquiryCount.value = "";
        
        // 2. Reset radio buttons
        filterGun.querySelector('input[value="전체"]').checked = true;
        
        // 3. Reset checkbox groups
        filterExcludeSubject.querySelectorAll('input:checked').forEach(cb => cb.checked = false);
        
        // 4. Reset custom multiselects
        const regionDropdown = filterRegionCustom.querySelector('.multiselect-dropdown');
        regionDropdown.querySelectorAll('input:checked').forEach(cb => cb.checked = false);
        updateMultiselectDisplay(filterRegionCustom, '- 지역 선택 -');
        
        const eventDropdown = filterExcludeEventCustom.querySelector('.multiselect-dropdown');
        eventDropdown.querySelectorAll('input:checked').forEach(cb => cb.checked = false);
        updateMultiselectDisplay(filterExcludeEventCustom, '- 종목 선택 -');
        
        // 5. Re-render
        renderFilteredResults();
    };
    
    // [NEW] Add listener for reset button
    filterResetBtn.addEventListener('click', resetFilters);


    const studentInfoContainer = document.getElementById('student-info-container');

    let allFilterData = [];
    let allStudents = [];
    let selectedStudentData = null;
    let universityFormulas = {};
    let studentWishlist = [];

    let currentSilgiEventMap = null;

    const WOMENS_UNIVERSITIES = ['이화여자대학교', '숙명여자대학교', '성신여자대학교', '덕성여자대학교', '동덕여자대학교','서울여자대학교'];

    const getToken = () => localStorage.getItem('jwt_token');
    
    // [MODIFIED] Hoisting fix: Use function declaration
    function handleAuthError() {
        alert('인증 만료. 다시 로그인하세요.');
        window.top.location.href = LOGIN_PAGE;
    };

    const debounce = (func, delay) => {
        let timeoutId;
        return (...args) => {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => {
                func.apply(this, args);
            }, delay);
        };
    };

    // [MODIFIED] Hoisting fix: Use function declaration
    function showToast(message, isSuccess = true) {
        const el = document.createElement('div');
        el.textContent = message;
        el.className = `toast-popup ${isSuccess ? 'success' : 'error'}`;
        document.body.appendChild(el);
        setTimeout(() => el.classList.add('show'), 10);
        setTimeout(() => {
            el.classList.remove('show');
            setTimeout(() => el.remove(), 500);
        }, 2500);
    };

    // [MODIFIED] Hoisting fix: Use function declaration
    function safeParse(v, fb = null) {
        if (typeof v === 'object' && v !== null) return v;
        if (typeof v !== 'string' || !v) return fb;
        try { return JSON.parse(v); } catch { return fb; }
    };

    // [MOVED UP & MODIFIED] saveCurrentWishlist is now defined earlier
    let isSaving = false;
    const saveCurrentWishlist = debounce(async function(){ // Use 'function' or arrow func, it's ok here
        if (!selectedStudentData || isSaving) return;
        isSaving = true;
        const studentId = selectedStudentData.student_id;
        const year = yearSelect.value;
        const items = [];
        document.querySelectorAll('.results-area .result-card').forEach(card=>{
            const formula = JSON.parse(card.dataset.formula);
            const gunSection = card.closest('.gun-section');
            const 모집군 = gunSection.id==='ga-gun'?'가':(gunSection.id==='na-gun'?'나':'다');
            const naInput = card.querySelector('.naeshin-input');
            const naVal = naInput && naInput.value.trim()!=='' ? Number(naInput.value) : null;
            const silgiObj = {};
            card.querySelectorAll('.practical-input').forEach(inp=>{
                if (inp.value.trim()!=='') silgiObj[inp.dataset.event] = inp.value.trim();
            });
            const su = Number(card.querySelector('.score-suneung').textContent||0);
            const silgiScoreText = card.querySelector('.score-silgi').textContent;
            const silgiNumMatch = silgiScoreText.match(/[\d\.]+/);
            const silgiNum = silgiNumMatch ? Number(silgiNumMatch[0]) : 0;
            const total = Number(card.querySelector('.score-total').textContent||0);
            items.push({
                모집군,
                대학학과_ID: formula.U_ID,
                상담_수능점수: su,
                상담_내신점수: naVal,
                상담_실기기록: Object.keys(silgiObj).length ? silgiObj : null,
                상담_실기반영점수: silgiNum,
                상담_계산총점: total
            });
        });
        try {
            const token = getToken(); if (!token) throw new Error('로그인 만료');
            const res = await fetch(`${SVR_JUNGSI}/jungsi/counseling/wishlist/bulk-save`, {
                method: 'POST',
                headers:{ 'Content-Type':'application/json','Authorization':`Bearer ${token}` },
                body: JSON.stringify({ 학생_ID: studentId, 학년도: year, wishlistItems: items })
            });
            if (res.status===401||res.status===403) { handleAuthError(); return; }
            const data = await res.json();
            if (data.success) {
                showToast('자동 저장됨');
            } else {
                showToast('저장 실패', false);
            }
        } catch (e) {
            console.error(e);
            showToast('저장 중 오류', false);
            if (e.message==='로그인 만료') handleAuthError();
        } finally {
            isSaving = false;
        }
    }, 1500);

    /* =========================
       1. 학생 목록 로드
    ========================== */
    // [MODIFIED] Hoisting fix: Use function declaration
    async function loadStudents() {
        const year = yearSelect.value;
        studentSelect.innerHTML = '<option value="">- 로딩 중... -</option>';
        try {
            const token = getToken();
            if (!token) throw new Error('로그인 만료');
            const res = await fetch(`${SVR_JUNGSI}/jungsi/students/list-by-branch?year=${year}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (res.status === 401 || res.status === 403) { handleAuthError(); return; }
            const data = await res.json();
            if (data.success && data.students) {
                allStudents = data.students;
                allStudents.sort((a,b)=>a.student_name.localeCompare(b.student_name,'ko'));
                studentSelect.innerHTML = '<option value="">- 학생 선택 -</option>';
                allStudents.forEach(s => {
                    studentSelect.innerHTML += `<option value="${s.student_id}">${s.student_name} (${s.school_name || '학교정보없음'})</option>`;
                });
            } else {
                allStudents = [];
                studentSelect.innerHTML = '<option value="">- 학생 없음 -</option>';
            }
        } catch (e) {
            console.error('학생 목록 로딩 실패', e);
            studentSelect.innerHTML = '<option value="">- 로딩 오류 -</option>';
            if (e.message === '로그인 만료') handleAuthError();
        }
    };

    /* =========================
       2. 필터 데이터 로드
    ========================== */
    // [MODIFIED] Hoisting fix: Use function declaration
    async function loadFilterData() {
        const year = yearSelect.value;
        allFilterData = [];
        universityFormulas = {};

        const regionDropdown = filterRegionCustom.querySelector('.multiselect-dropdown');
        const eventDropdown = filterExcludeEventCustom.querySelector('.multiselect-dropdown');
        regionDropdown.innerHTML = '<label>로딩 중...</label>';
        eventDropdown.innerHTML = '<label>로딩 중...</label>';
        updateMultiselectDisplay(filterRegionCustom, '- 지역 선택 -');
        updateMultiselectDisplay(filterExcludeEventCustom, '- 종목 선택 -');
        filterResultsContainer.style.display = 'none';

        try {
            const token = getToken(); if (!token) throw new Error('로그인 만료');
            const res = await fetch(`${SVR_JUNGSI}/jungsi/filter-data/${year}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (res.status === 401 || res.status === 403) { handleAuthError(); return; }
            const data = await res.json();
            if (data.success && data.data) {
                allFilterData = data.data;

                // 지역
                const regions = [...new Set(data.data.map(d => d.지역).filter(Boolean))];
                const priority = ['서울','경기','인천'];
                regions.sort((a,b)=>{
                    const ap = priority.includes(a), bp = priority.includes(b);
                    if (ap && !bp) return -1;
                    if (!ap && bp) return 1;
                    if (ap && bp) return priority.indexOf(a)-priority.indexOf(b);
                    return a.localeCompare(b,'ko');
                });
                regionDropdown.innerHTML='';
                regions.forEach(r=>{
                    regionDropdown.innerHTML += `<label><input type="checkbox" value="${r}"> ${r}</label>`;
                });

                // 실기 종목
                const eventSet = new Set();
                data.data.forEach(d=>{
                    if (d.practical_events) {
                        d.practical_events.split(',').forEach(e=>{
                            const t=e.trim();
                            if (t) eventSet.add(t);
                        });
                    }
                });
                const events = [...eventSet].sort((a,b)=>a.localeCompare(b,'ko'));
                eventDropdown.innerHTML='';
                events.forEach(e=>{
                    eventDropdown.innerHTML += `<label><input type="checkbox" value="${e}"> ${e}</label>`;
                });

                initCustomMultiselects();

                if (selectedStudentData) {
                    renderFilteredResults();
                    filterResultsContainer.style.display = 'block';
                }
            } else {
                regionDropdown.innerHTML = '<label>목록 없음</label>';
                eventDropdown.innerHTML = '<label>목록 없음</label>';
            }
        } catch (e) {
            console.error('필터 데이터 로딩 오류', e);
            regionDropdown.innerHTML = '<label>로딩 오류</label>';
            eventDropdown.innerHTML = '<label>로딩 오류</label>';
            if (e.message === '로그인 만료') handleAuthError();
        }
    };

    // [MODIFIED] Hoisting fix: Use function declaration
    function initCustomMultiselects() {
        document.querySelectorAll('.custom-multiselect').forEach(container => {
            const display = container.querySelector('.multiselect-display');
            const dropdown = container.querySelector('.multiselect-dropdown');
            const placeholder = container.querySelector('.placeholder')?.textContent || '';

            display.addEventListener('click', (e)=>{
                e.stopPropagation();
                document.querySelectorAll('.custom-multiselect.open').forEach(c=>{
                    if (c!==container) c.classList.remove('open');
                });
                container.classList.toggle('open');
            });

            dropdown.addEventListener('change', (e)=>{
                e.stopPropagation();
                updateMultiselectDisplay(container, placeholder);
                renderFilteredResults(); // [MODIFIED] Already triggers live filtering
            });

            dropdown.addEventListener('click', (e)=> e.stopPropagation());
        });
    };

    window.addEventListener('click', ()=>{
        document.querySelectorAll('.custom-multiselect.open').forEach(c=>c.classList.remove('open'));
    });

    // [MODIFIED] Hoisting fix: Use function declaration
    function updateMultiselectDisplay(container, placeholder) {
        const span = container.querySelector('.multiselect-display span');
        const checked = container.querySelectorAll('.multiselect-dropdown input:checked').length;
        if (checked===0) {
            span.textContent = placeholder;
            span.classList.add('placeholder');
        } else {
            span.textContent = `${checked}개 선택됨`;
            span.classList.remove('placeholder');
        }
    };

    /* =========================
       3. 필터 결과 렌더링
    ========================== */
    // [MODIFIED] Hoisting fix: Use function declaration
    function renderFilteredResults() {
        if (!selectedStudentData) {
            filterResultsContainer.style.display='none';
            return;
        }
        filterResultsContainer.style.display='block';
        const selectedGun = document.querySelector('input[name="gun-filter"]:checked').value;
        const selectedRegions = Array.from(filterRegionCustom.querySelectorAll('input:checked')).map(i=>i.value);
        const selectedTeaching = filterTeaching.value;
        const excludedSubjects = Array.from(filterExcludeSubject.querySelectorAll('input:checked')).map(i=>i.value);
        const selectedInquiryCount = filterInquiryCount.value;
        const excludedEvents = Array.from(filterExcludeEventCustom.querySelectorAll('input:checked')).map(i=>i.value);
        const studentGender = selectedStudentData.gender;

        const filtered = allFilterData.filter(dept=>{
            if (selectedGun!=='전체' && dept.군!==selectedGun) return false;
            if (selectedRegions.length>0 && !selectedRegions.includes(dept.지역)) return false;
            if (selectedTeaching==='가능' && (dept.교직!=='O' && dept.교직!=='△')) return false;
            if (selectedTeaching==='불가' && (dept.교직==='O' || dept.교직==='△')) return false;
            if (excludedSubjects.includes('국어') && dept.국어_raw && !dept.국어_raw.startsWith('(')) return false;
            if (excludedSubjects.includes('수학') && dept.수학_raw && !dept.수학_raw.startsWith('(')) return false;
            if (excludedSubjects.includes('영어') && dept.영어_raw && !dept.영어_raw.startsWith('(')) return false;
            if (excludedSubjects.includes('탐구') && dept.탐구_raw && !dept.탐구_raw.startsWith('(')) return false;
            if (selectedInquiryCount && String(dept.탐구수_raw)!==selectedInquiryCount) return false;
            if (excludedEvents.length>0 && dept.practical_events) {
                const deptEv = dept.practical_events.split(',').map(e=>e.trim());
                if (excludedEvents.some(ev=>deptEv.includes(ev))) return false;
            }
            if (studentGender==='남' && WOMENS_UNIVERSITIES.includes(dept.대학명)) return false;
            return true;
        });

        filterCount.textContent = `총 ${filtered.length}개 학과 조회됨`;

        if (filtered.length===0) {
            filterResultsBody.innerHTML = `<tr class="empty-msg"><td colspan="13">필터 조건에 맞는 대학이 없습니다.</td></tr>`;
            return;
        }

        let html='';
        filtered.forEach(dept=>{
            const raw = {
                kor: dept.국어_raw || '',
                math: dept.수학_raw || '',
                eng: dept.영어_raw || '',
                inq: dept.탐구_raw || '',
                hist: dept.한국사_raw || ''
            };
            const formatSubject = (label, value)=>{
                if (!value) return `<span class="empty">${label} -</span>`;
                if (value.startsWith('(')) return `<span class="optional">${label} ${value}</span>`;
                return `<span>${label} ${value}</span>`;
            };
            const subjectsHtml = `${formatSubject('국', raw.kor)} ${formatSubject('수', raw.math)} ${formatSubject('영', raw.eng)} ${formatSubject('탐', raw.inq)} ${formatSubject('한', raw.hist)}`;
            const gunClass = `info-gun-${dept.군}`;
            const regionText = `${(dept.지역||'')} ${(dept.시구||'')}`.trim() || '정보없음';
            let teachHtml='';
            if (dept.교직==='O') teachHtml='<span class="info-teach-O">교직(가능)</span>';
            else if (dept.교직==='△') teachHtml='<span class="info-teach-T">교직(일부)</span>';

            const formatPercent = p => (p==null||p==='')?'-':`${parseFloat(p)}`;

            const branchCutView = (dept.branch_suneung_cut != null && dept.branch_suneung_cut !== '') ? dept.branch_suneung_cut : '-';
            const maxCutView = (dept.max_suneung_cut != null && dept.max_suneung_cut !== '') ? dept.max_suneung_cut : '-';

            html += `
            <tr data-uid="${dept.U_ID}">
                <td>
                    <strong class="univ-name">${dept.대학명}</strong>
                    <span class="dept-name">${dept.학과명}</span>
                </td>
                <td class="col-info">
                    <span class="${gunClass}">${dept.군 || '?'}군</span>
                    <span class="info-region">${regionText}</span>
                    ${teachHtml}
                </td>
                <td class="col-numeric">${dept.모집정원 || '-'}</td>
                <td class="col-percent">${formatPercent(dept.수능)}</td>
                <td class="col-percent">${formatPercent(dept.내신)}</td>
                <td class="col-percent">${formatPercent(dept.실기)}</td>
                <td class="col-subjects">${subjectsHtml}</td>
                <td class="col-events">${dept.practical_events ? dept.practical_events.replace(/,/g, ', ') : '-'}</td>
                <td class="col-numeric">${dept.탐구수_raw || '-'}</td>
                <td class="col-score suneung-score-cell" id="suneung-score-${dept.U_ID}">
                    <span class="score-loading"><i class="fas fa-spinner fa-spin"></i></span>
                </td>
                <td class="col-cut">${branchCutView}</td>
                <td class="col-cut">${maxCutView}</td>
                <td class="col-actions">
                    <button type="button" class="btn btn-success btn-sm btn-add" data-uid-add="${dept.U_ID}">
                        <i class="fas fa-plus"></i> 추가
                    </button>
                </td>
            </tr>`;
        });
        filterResultsBody.innerHTML = html;

        filterResultsBody.querySelectorAll('.btn-add').forEach(btn=>{
            btn.addEventListener('click', (e)=>{
                const uid = e.currentTarget.dataset.uidAdd;
                e.currentTarget.disabled = true;
                e.currentTarget.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                addUniversityToWishlist(uid, e.currentTarget);
            });
        });

        calculateScoresForVisibleRows(filtered);
    };

    /* =========================
       4. 환산점수 계산
    ========================== */
    // [MODIFIED] Hoisting fix: Use function declaration
    async function calculateScoresForVisibleRows(rows) {
        if (!selectedStudentData) return;
        const year = yearSelect.value;
        const jobs = rows.map(dept =>
            calculateSuneung(selectedStudentData, dept.U_ID, year)
                .then(score => ({ uid: dept.U_ID, score, cut: dept.branch_suneung_cut }))
                .catch(e => ({ uid: dept.U_ID, score: null, error: e }))
        );
        const results = await Promise.all(jobs);
        results.forEach(r=>{
            const cell = document.getElementById(`suneung-score-${r.uid}`);
            if (!cell) return;
            if (r.score==null) {
                cell.innerHTML = `<span class="score-low">계산오류</span>`;
                return;
            }
            const score = r.score;
            const cut = parseFloat(r.cut);
            let cls = 'score-none';
            if (!isNaN(cut) && cut>0) cls = score >= cut ? 'score-high' : 'score-low';
            cell.innerHTML = `<strong class="${cls}">${score.toFixed(2)}</strong>`;
        });
    };

    /* =========================
       5. 상담목록 추가
    ========================== */
    // [MODIFIED] Hoisting fix: Use function declaration
    async function addUniversityToWishlist(U_ID, btnEl=null) {
        if (!selectedStudentData) {
            showToast('학생을 먼저 선택하세요', false);
            if (btnEl) { btnEl.disabled=false; btnEl.innerHTML='<i class="fas fa-plus"></i> 추가'; }
            return;
        }
        const year = yearSelect.value;
        const dept = allFilterData.find(d => String(d.U_ID)===String(U_ID));
        if (!dept) {
            showToast('해당 학과 정보를 찾을 수 없습니다', false);
            if (btnEl) { btnEl.disabled=false; btnEl.innerHTML='<i class="fas fa-plus"></i> 추가'; }
            return;
        }
        const gunSectionId = getGunSectionId(dept.군);
        const gunSection = document.getElementById(gunSectionId);
        const container = gunSection.querySelector('.result-cards-container');
        const exist = container.querySelector(`.result-card[data-uid="${U_ID}"]`);
        if (exist) {
            showToast('이미 추가된 학과입니다.', false);
            if (btnEl) { btnEl.disabled=false; btnEl.innerHTML='<i class="fas fa-plus"></i> 추가'; }
            return;
        }
        const currentCount = container.querySelectorAll('.result-card').length;
        if (currentCount>=3) {
            showToast(`${dept.군}에는 최대 3개만`, false);
            if (btnEl) { btnEl.disabled=false; btnEl.innerHTML='<i class="fas fa-plus"></i> 추가'; }
            return;
        }

        try {
            const formula = await fetchFormulaDetails(U_ID, year);
            if (!formula) throw new Error('요강 로딩 실패');
            if (WOMENS_UNIVERSITIES.includes(formula.대학명) && selectedStudentData.gender==='남') {
                showToast(`남학생은 ${formula.대학명} 불가`, false);
                throw new Error('gender mismatch');
            }
            const suneungScore = await calculateSuneung(selectedStudentData, U_ID, year);
            const card = createResultCard(container, formula, suneungScore);
            updateGunCount(gunSectionId);
            // 여기서 우리가 바꾼 버전 호출
            fetchAndDisplayDeptStats(card, U_ID, year);
            saveCurrentWishlist();
        } catch (e) {
            console.error(e);
            showToast(e.message || '추가 중 오류', false);
        } finally {
            if (btnEl) {
                btnEl.disabled=false;
                btnEl.innerHTML='<i class="fas fa-plus"></i> 추가';
            }
        }
    };

    // [MODIFIED] Hoisting fix: Use function declaration
    async function fetchFormulaDetails(U_ID, year) {
        const k = `${U_ID}-${year}`;
        if (universityFormulas[k]) return universityFormulas[k];
        try {
            const token = getToken(); if (!token) throw new Error('로그인 만료');
            const res = await fetch(`${SVR_JUNGSI}/jungsi/formula-details?U_ID=${U_ID}&year=${year}`,{
                headers:{ 'Authorization':`Bearer ${token}` }
            });
            if (res.status===401||res.status===403) throw new Error('인증 오류');
            const data = await res.json();
            if (!data.success) throw new Error(data.message || '조회 실패');
            universityFormulas[k] = data.formula;
            return data.formula;
        } catch (e) {
            console.error(e);
            if (e.message.includes('인증')) handleAuthError();
            return null;
        }
    };

    // [MODIFIED] Hoisting fix: Use function declaration
    async function calculateSuneung(student, U_ID, year) {
        if (!student || !student.scores) return 0;
        try {
            const token = getToken(); if (!token) throw new Error('로그인 만료');
            const res = await fetch(`${SVR_JUNGSI}/jungsi/calculate`, {
                method: 'POST',
                headers: { 'Content-Type':'application/json','Authorization':`Bearer ${token}` },
                body: JSON.stringify({
                    U_ID,
                    year,
                    studentScores: convertScoresToSuneungFormat(student.scores)
                })
            });
            if (res.status===401||res.status===403) throw new Error('인증 오류');
            const data = await res.json();
            if (!data.success) return 0;
            return Number(data.result?.totalScore || 0);
        } catch (e) {
            console.error(e);
            if (e.message.includes('인증')) handleAuthError();
            return 0;
        }
    };

    // [MODIFIED] Hoisting fix: Use function declaration
    function convertScoresToSuneungFormat(s) {
        if (!s) return { subjects: [] };
        const subjects = [];
        if (s.국어_표준점수!=null || s.국어_백분위!=null)
            subjects.push({ name:'국어', subject:s.국어_선택과목, std:s.국어_표준점수, percentile:s.국어_백분위, grade:s.국어_등급 });
        if (s.수학_표준점수!=null || s.수학_백분위!=null)
            subjects.push({ name:'수학', subject:s.수학_선택과목, std:s.수학_표준점수, percentile:s.수학_백분위, grade:s.수학_등급 });
        if (s.영어_등급!=null) subjects.push({ name:'영어', grade:s.영어_등급 });
        if (s.한국사_등급!=null) subjects.push({ name:'한국사', grade:s.한국사_등급 });
        if (s.탐구1_선택과목) subjects.push({ name:'탐구', subject:s.탐구1_선택과목, std:s.탐구1_표준점수, percentile:s.탐구1_백분위, grade:s.탐구1_등급 });
        if (s.탐구2_선택과목) subjects.push({ name:'탐구', subject:s.탐구2_선택과목, std:s.탐구2_표준점수, percentile:s.탐구2_백분위, grade:s.탐구2_등급 });
        return { subjects };
    };

    // [MODIFIED] Hoisting fix: Use function declaration
    function createResultCard(container, formula, suneungScore, savedData=null) {
        const card = document.createElement('div');
        card.className='result-card';
        card.dataset.uid = formula.U_ID;
        card.dataset.formula = JSON.stringify(formula);

        const reflectsNaeshin = Number(formula.내신||0)>0;
        const reflectsSilgi = Number(formula.실기||0)>0;

        let silgiInputsHtml='';
        let practicalEventsForStudent=[];
        if (reflectsSilgi && selectedStudentData && selectedStudentData.gender && formula.실기배점 && formula.실기배점.length>0) {
            const stuGender = selectedStudentData.gender;
            const genderRows = formula.실기배점.filter(r=>r.성별===stuGender);
            practicalEventsForStudent = [...new Set(genderRows.map(r=>r.종목명))].sort();
            if (practicalEventsForStudent.length>0) {
                practicalEventsForStudent.forEach(ev=>{
                    silgiInputsHtml += `
                    <tr class="practical-row">
                        <th>${ev}:</th>
                        <td>
                            <input type="text" class="practical-input" data-event="${ev}" placeholder="기록 입력">
                            <span class="practical-score-display" data-event-score-display="${ev}">-</span>
                        </td>
                    </tr>`;
                });
            } else {
                silgiInputsHtml = `<tr><td colspan="2" style="font-size:.8rem;color:#888;text-align:center;">${stuGender}학생 실기 없음</td></tr>`;
            }
        }

        let naeshinInputHtml='';
        if (reflectsNaeshin) {
            naeshinInputHtml = `
            <tr class="naeshin-row">
                <th>내신 점수:</th>
                <td><input type="number" class="naeshin-input" placeholder="진학사 점수"></td>
            </tr>`;
        }

        card.innerHTML = `
            <div class="result-card-header">
                <div class="left">
                    <button type="button" class="btn btn-danger btn-sm remove-card-btn" title="삭제"><i class="fas fa-times"></i></button>
                    <h3>${formula.대학명}<span>${formula.학과명}</span></h3>
                </div>
                <div class="right">
                    <div class="top-metrics" data-uid-metrics="${formula.U_ID}">
                        <div class="metric top10"><span class="loading">상위10%: -</span></div>
                        <div class="metric branch">지점 총점컷: -</div>
                        <div class="metric max">MAX 총점컷: -</div>
                    </div>
                </div>
            </div>
            <div class="result-card-body">
                <div class="score-breakdown">
                    <table>
                        <tr><th>수능 점수:</th><td class="score-suneung">${suneungScore.toFixed(2)}</td></tr>
                        <tr class="naeshin-score-row" style="${reflectsNaeshin?'':'display:none;'}"><th>내신 점수:</th><td class="score-naeshin">0.00</td></tr>
                        <tr><th>실기 점수:</th><td class="score-silgi">0.00 <span>(0감)</span></td></tr>
                        <tr class="total-score"><th>총점:</th><td class="score-total">${suneungScore.toFixed(2)}</td></tr>
                    </table>
                </div>
                <div class="input-section">
                    <table>
                        ${naeshinInputHtml}
                        ${silgiInputsHtml}
                    </table>
                </div>
                <div class="card-actions"></div>
            </div>
        `;
        const actions = card.querySelector('.card-actions');
        if (reflectsSilgi && practicalEventsForStudent.length>0) {
            const b = document.createElement('button');
            b.className='btn btn-sm btn-outline';
            b.innerHTML='<i class="fas fa-table"></i> 실기 배점표';
            b.onclick = ()=>showScoreTableModal('silgi', formula.U_ID, formula.학년도);
            actions.appendChild(b);
        }
        if (reflectsNaeshin && formula.내신배점?.length) {
            const b = document.createElement('button');
            b.className='btn btn-sm btn-outline';
            b.innerHTML='<i class="fas fa-table"></i> 내신 배점표';
            b.onclick = ()=>showScoreTableModal('naeshin', formula.U_ID, formula.학년도);
            actions.appendChild(b);
        }
        const b2 = document.createElement('button');
        b2.className='btn btn-sm btn-outline';
        b2.innerHTML='<i class="fas fa-users"></i> 타군 인기 지원';
        b2.onclick = ()=>showCrossGunModal(formula.U_ID, formula.학년도, formula.대학명, formula.학과명, formula.군);
        actions.appendChild(b2);

        if (savedData) {
            const ninput = card.querySelector('.naeshin-input');
            if (ninput && savedData.상담_내신점수!=null) ninput.value = savedData.상담_내신점수;
            const savedSilgi = safeParse(savedData.상담_실기기록, {});
            if (savedSilgi && typeof savedSilgi==='object') {
                card.querySelectorAll('.practical-input').forEach(input=>{
                    const ev = input.dataset.event;
                    if (ev in savedSilgi) input.value = savedSilgi[ev];
                });
            }
            recalcCard(card);
        }

        card.querySelectorAll('.naeshin-input, .practical-input').forEach(inp=>{
            inp.addEventListener('change', ()=>recalcCard(card));
        });

        card.querySelector('.remove-card-btn').addEventListener('click', ()=>{
            const sec = card.closest('.gun-section');
            card.remove();
            if (sec) updateGunCount(sec.id);
            saveCurrentWishlist();
        });

        container.appendChild(card);
        return card;
    };

    // [MODIFIED] Hoisting fix: Use function declaration
    async function recalcCard(card) {
        const formula = JSON.parse(card.dataset.formula);
        const student = selectedStudentData;
        if (!formula || !student) return;

        let na = 0;
        const ninput = card.querySelector('.naeshin-input');
        if (ninput) {
            const raw = Number(ninput.value || 0);
            const ratio = Number(formula.내신||0)/100;
            const total = Number(formula.총점)||1000;
            const max = Number(formula.내신만점)||0;
            if (ratio>0 && max>0 && raw>0) na = (raw/max)*ratio*total;
            else if (ratio>0 && raw>0 && max===0) na = raw;
        }
        card.querySelector('.score-naeshin').textContent = na.toFixed(2);

        let silgi = 0;
        let totalDeductionText = '<span>(0감)</span>';
        const inputs = card.querySelectorAll('.practical-input');
        const entered = [];
        inputs.forEach(i=>{
            if (i.value.trim()!=='') entered.push({ event:i.dataset.event, value:i.value.trim() });
        });

        if (entered.length>0) {
            try {
                const token = getToken(); if (!token) throw new Error('로그인 만료');
                const res = await fetch(`${SVR_JUNGSI}/silgi/calculate`, {
                    method: 'POST',
                    headers: { 'Content-Type':'application/json','Authorization':`Bearer ${token}` },
                    body: JSON.stringify({
                        F_data: formula,
                        S_data: { gender: student.gender, practicals: entered }
                    })
                });
                if (res.status===401||res.status===403) throw new Error('인증 오류');
                const data = await res.json();
                if (data.success && data.result) {
                    silgi = Number(data.result.totalScore||0);
                    const br = data.result.breakdown;
                    if (br?.events) {
                        br.events.forEach(ev=>{
                            const sp = card.querySelector(`.practical-score-display[data-event-score-display="${ev.event}"]`);
                            if (sp) sp.innerHTML = ev.score==null?'-':`${ev.score.toFixed(2)}점 <span>(${ev.deduction_level}감)</span>`;
                        });
                    }
                    const d = br?.total_deduction_level || 0;
                    totalDeductionText = d>0 ? `<span>(${d}감)</span>` : '<span>(0감)</span>';
                }
            } catch (e) {
                console.error('실기 계산 오류', e);
                if (e.message.includes('인증')) handleAuthError();
            }
        } else {
            card.querySelectorAll('.practical-score-display').forEach(s=>s.textContent='-');
        }
        card.querySelector('.score-silgi').innerHTML = `${silgi.toFixed(2)} ${totalDeductionText}`;

        const su = Number(card.querySelector('.score-suneung').textContent||0);
        const total = su + na + silgi;
        card.querySelector('.score-total').textContent = total.toFixed(2);

        saveCurrentWishlist();
    };

    // [MODIFIED] Hoisting fix: Use function declaration
    function updateGunCount(id) {
        const sec = document.getElementById(id);
        if (!sec) return;
        const c = sec.querySelector('.result-cards-container');
        const span = sec.querySelector('.gun-count');
        span.textContent = `${c.querySelectorAll('.result-card').length} / 3`;
    };

    // [MODIFIED] Hoisting fix: Use function declaration
    function getGunSectionId(gun) {
        if (gun==='가군'||gun==='가') return 'ga-gun';
        if (gun==='나군'||gun==='나') return 'na-gun';
        if (gun==='다군'||gun==='다') return 'da-gun';
        return '';
    };

    // [MODIFIED] Hoisting fix: Use function declaration
    function resetResultArea() {
        ['ga-gun','na-gun','da-gun'].forEach(id=>{
            const c = document.getElementById(id)?.querySelector('.result-cards-container');
            if (c) c.innerHTML='';
            updateGunCount(id);
        });
    };

    /* =========================
       ★ 여기: 카드 위쪽 컷 표시 (API 안 때림)
    ========================== */
   // ★ 카드 위쪽 상위10% + 지점/MAX 총점컷 표시
   // [MODIFIED] Hoisting fix: Use function declaration
    async function fetchAndDisplayDeptStats(card, U_ID, year) {
        const box = card.querySelector(`.top-metrics[data-uid-metrics="${U_ID}"]`);
        if (!box) return;

        // 1) 먼저 /jungsi/filter-data/:year 에서 이미 받아온 값으로 컷 보여주기
        const dept = allFilterData.find(d => String(d.U_ID) === String(U_ID));

        // 기본값 세팅
        let branchTotalView = '-';
        let maxTotalView = '-';

        if (dept) {
            // 프론트 테이블에서 쓰던 컬럼명 그대로 재사용
            if (dept.branch_total_cut != null && dept.branch_total_cut !== '') {
                branchTotalView = Number(dept.branch_total_cut).toFixed(2);
            }
            if (dept.max_total_cut != null && dept.max_total_cut !== '') {
                maxTotalView = Number(dept.max_total_cut).toFixed(2);
            }
        }

        // 일단 컷 먼저 찍어둔다 (API 늦어도 이것부터 보여야 하니까)
        box.querySelector('.metric.branch').innerHTML =
            `<i class="fas fa-building-user"></i> 지점 총점컷: <strong>${branchTotalView}</strong>`;
        box.querySelector('.metric.max').innerHTML =
            `<i class="fas fa-crown"></i> MAX 총점컷: <strong>${maxTotalView}</strong>`;

        // 2) 이제 진짜 카드용 API 호출 (이미 서버에 있는 거)
        //    👉 /jungsi/counseling/stats/:U_ID/:year
        try {
            const token = localStorage.getItem('jwt_token');
            if (!token) throw new Error('로그인 만료');

            const res = await fetch(`${SVR_JUNGSI}/jungsi/counseling/stats/${U_ID}/${year}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (res.status === 401 || res.status === 403) {
                box.querySelector('.metric.top10').innerHTML =
                    `<i class="fas fa-medal"></i> 상위10%: -`;
                return;
            }

            const data = await res.json();

            // 서버가 어떤 모양으로 주는지 모르니까 최대한 흡수
            // 예) { success:true, data:{...} }  /  { success:true, stats:{...} }  /  { success:true, top10Score:... }
            const payload = data.data || data.stats || data;

            // 상위10% 후보 키 전부 다 열어둠
            const top10 =
                payload.top10Score ??
                payload.top10 ??
                payload.top_10 ??
                payload.top10_total ??
                null;

            // 혹시 여기서 총점컷도 다시 내려주면 이걸로 덮어쓰기
            const branchFromApi =
                payload.branch_total_cut ??
                payload.branchTotal ??
                payload.branch_total ??
                null;

            const maxFromApi =
                payload.max_total_cut ??
                payload.maxTotal ??
                payload.max_total ??
                null;

            // 상위10% 표시
            if (top10 != null) {
                box.querySelector('.metric.top10').innerHTML =
                    `<i class="fas fa-medal"></i> 상위수능10%: <strong>${Number(top10).toFixed(2)}</strong>`;
            } else {
                box.querySelector('.metric.top10').innerHTML =
                    `<i class="fas fa-medal"></i> 상위수능10%: -`;
            }

            // 서버가 카드용 총점컷도 같이 줬다면 그걸로 덮어쓰기
            if (branchFromApi != null) {
                box.querySelector('.metric.branch').innerHTML =
                    `<i class="fas fa-building-user"></i> 지점 총점컷: <strong>${Number(branchFromApi).toFixed(2)}</strong>`;
            }
            if (maxFromApi != null) {
                box.querySelector('.metric.max').innerHTML =
                    `<i class="fas fa-crown"></i> MAX 총점컷: <strong>${maxFromApi.toFixed(2)}</strong>`;
            }

        } catch (err) {
            console.error('카드 통계 불러오기 오류:', err);
            box.querySelector('.metric.top10').innerHTML =
                `<i class="fas fa-medal"></i> 상위10%: -`;
            // 컷은 위에서 한 번 찍어놨으니까 여기서는 안 건드림
        }
    };

    /* =========================
       6. 배점표 모달 (드롭다운)
    ========================== */
    window.showScoreTableModal = async (type, U_ID, year) => {
        scoreTableModal.style.display = 'block';
        scoreTableModalBody.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> 배점표 로딩 중...</p>';

        const detail = await fetchFormulaDetails(U_ID, year);
        if (!detail) {
            scoreTableModalBody.innerHTML = '<p style="color:red;">요강 정보를 불러오지 못했습니다.</p>';
            return;
        }

        const uniName = detail.대학명 || '';
        const deptName = detail.학과명 || '';
        scoreTableModalTitle.textContent = `${uniName} - ${deptName} ${type==='silgi' ? '(실기)' : '(내신)'} 배점표`;

        if (type === 'naeshin') {
            const html = createNaeshinScoreTableHtml(detail.내신배점 || []);
            scoreTableModalBody.innerHTML = html;
            return;
        }

        const silgiList = detail.실기배점 || [];
        if (!silgiList.length) {
            scoreTableModalBody.innerHTML = '<p style="font-size:.85rem;">실기 배점표가 없습니다.</p>';
            return;
        }

        const eventMap = {};
        silgiList.forEach(row => {
            const ev = row.종목명 || '기타';
            if (!eventMap[ev]) eventMap[ev] = [];
            eventMap[ev].push(row);
        });

        const eventNames = Object.keys(eventMap).sort((a,b)=>{
            const aMin = Math.min(...eventMap[a].map(r=>Number(r.id)||999999));
            const bMin = Math.min(...eventMap[b].map(r=>Number(r.id)||999999));
            return aMin - bMin;
        });

        currentSilgiEventMap = eventMap;

        const firstEvent = eventNames[0];

        scoreTableModalBody.innerHTML = `
            <div class="silgi-modal-top">
                <label for="silgi-event-select">종목 선택</label>
                <select id="silgi-event-select">
                    ${eventNames.map(ev=>`<option value="${ev}">${ev}</option>`).join('')}
                </select>
            </div>
            <div id="silgi-event-table-wrap"></div>
        `;

        renderSilgiEventTable(firstEvent);

        const sel = document.getElementById('silgi-event-select');
        sel.addEventListener('change', (e)=>{
            renderSilgiEventTable(e.target.value);
        });
    };

    // [MODIFIED] Hoisting fix: Use function declaration
    function renderSilgiEventTable(eventName) {
        const wrap = document.getElementById('silgi-event-table-wrap');
        if (!wrap || !currentSilgiEventMap) return;
        const rows = currentSilgiEventMap[eventName] || [];

        const hasScore = rows.some(r =>
            (r.점수 !== undefined && r.점수 !== null && r.점수 !== '') ||
            (r.배점 !== undefined && r.배점 !== null && r.배점 !== '')
        );

        if (hasScore) {
            const scoreMap = {};
            rows.forEach(r=>{
                let scoreVal =
                    (r.점수 !== undefined && r.점수 !== null && r.점수 !== '')
                        ? Number(r.점수)
                        : Number(r.배점);
                if (!Number.isFinite(scoreVal)) return;
                if (!scoreMap[scoreVal]) scoreMap[scoreVal] = { 남:'-', 여:'-' };
                if (r.성별==='남' || r.성별==='남자') {
                    scoreMap[scoreVal].남 = (r.기록 ?? r.남 ?? '-');
                } else if (r.성별==='여' || r.성별==='여자') {
                    scoreMap[scoreVal].여 = (r.기록 ?? r.여 ?? '-');
                }
            });
            const sortedScores = Object.keys(scoreMap).map(Number).sort((a,b)=>b-a);
            let html = `
                <table class="silgi-event-table">
                    <caption>${eventName}</caption>
                    <thead>
                        <tr>
                            <th style="width:80px;">배점</th>
                            <th>남</th>
                            <th>여</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            sortedScores.forEach(sc=>{
                const item = scoreMap[sc];
                html += `
                    <tr>
                        <td>${sc}</td>
                        <td>${item.남 ?? '-'}</td>
                        <td>${item.여 ?? '-'}</td>
                    </tr>
                `;
            });
            html += `</tbody></table>`;
            wrap.innerHTML = html;
            return;
        }

        const recordMap = {};
        rows.forEach(r=>{
            const key = (r.기록 ?? r.남 ?? r.여 ?? `row-${Math.random()}`);
            if (!recordMap[key]) recordMap[key] = { 남:'-', 여:'-' };
            if (r.성별==='남' || r.성별==='남자') recordMap[key].남 = r.기록 ?? r.남 ?? '-';
            else if (r.성별==='여' || r.성별==='여자') recordMap[key].여 = r.기록 ?? r.여 ?? '-';
            else recordMap[key].남 = r.기록 ?? '-';
        });

        const orderedKeys = Object.keys(recordMap).sort((a,b)=>{
            const na = Number(a), nb = Number(b);
            if (Number.isFinite(na) && Number.isFinite(nb)) return na-nb;
            return 0;
        });

        let html = `
            <table class="silgi-event-table">
                <caption>${eventName}</caption>
                <thead>
                    <tr>
                        <th style="width:80px;">배점</th>
                        <th>남</th>
                        <th>여</th>
                    </tr>
                </thead>
                <tbody>
        `;
        orderedKeys.forEach(k=>{
            const item = recordMap[k];
            html += `
                <tr>
                    <td>-</td>
                    <td>${item.남 ?? '-'}</td>
                    <td>${item.여 ?? '-'}</td>
                </tr>
            `;
        });
        html += `</tbody></table>`;
        wrap.innerHTML = html;
    };

    // [MODIFIED] Hoisting fix: Use function declaration
    function createNaeshinScoreTableHtml(scores) {
        if (!scores || !scores.length) {
            return '<p style="font-size:.85rem;">내신 배점표가 없습니다.</p>';
        }
        const headers = Object.keys(scores[0]).filter(h=>h!=='U_ID' && h!=='학년도');
        const order = ['등급','점수','비고'];
        const finalHeaders = order.filter(h=>headers.includes(h));
        headers.forEach(h=>{ if (!finalHeaders.includes(h)) finalHeaders.push(h); });
        let html = `<table class="silgi-event-table"><thead><tr>`;
        finalHeaders.forEach(h=> html += `<th>${h}</th>`);
        html += `</tr></thead><tbody>`;
        scores.sort((a,b)=>(Number(a.등급)||99) - (Number(b.등급)||99));
        scores.forEach(row=>{
            html += `<tr>`;
            finalHeaders.forEach(h=>{
                html += `<td>${row[h] ?? '-'}</td>`;
            });
            html += `</tr>`;
        });
        html += `</tbody></table>`;
        return html;
    };

    /* =========================
       7. 타군 모달
    ========================== */
    window.showCrossGunModal = async (U_ID, year, uniName, deptName, baseGun) => {
        crossGunModal.style.display='block';
        crossGunModalTitle.textContent = `${uniName} ${deptName} (${baseGun}) 지원자 타군`;
        crossGunModalBody.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> 로딩 중...</p>';
        try {
            const token = getToken(); if (!token) throw new Error('로그인 만료');
            const res = await fetch(`${SVR_JUNGSI}/jungsi/counseling/cross-gun-stats/${U_ID}/${year}`, {
                headers:{ 'Authorization':`Bearer ${token}` }
            });
            if (res.status===401||res.status===403) throw new Error('인증 오류');
            const data = await res.json();
            if (!data.success) {
                crossGunModalBody.innerHTML = `<p style="color:red;">${data.message || '조회 실패'}</p>`;
                return;
            }
            let html = `<p>(${data.studentCount || 0}명 기준)</p>`;
            ['가','나','다'].filter(g=>g!==baseGun).forEach(g=>{
                const arr = data[`${g}_gun_top3`] || [];
                html += `<h4>${g}군 Top ${arr.length}</h4>`;
                if (!arr.length) {
                    html += '<p style="font-size:.8rem;color:#888;">데이터 없음</p>';
                    return;
                }
                html += '<ul>';
                arr.forEach((it,idx)=>{
                    html += `<li><strong>${idx+1}. ${it.university}</strong> - ${it.department} (${it.count}명)</li>`;
                });
                html += '</ul>';
            });
            crossGunModalBody.innerHTML = html;
        } catch (e) {
            console.error(e);
            crossGunModalBody.innerHTML = `<p style="color:red;">오류: ${e.message}</p>`;
            if (e.message.includes('인증')) handleAuthError();
        }
    };

    /* =========================
       9. 저장된 상담목록 불러오기
    ========================== */
    // [MODIFIED] Hoisting fix: Use function declaration
    async function loadWishlist() {
        resetResultArea();
        if (!selectedStudentData) return;
        const studentId = selectedStudentData.student_id;
        const year = yearSelect.value;
        showToast('상담 목록 로딩 중...');
        try {
            const token = getToken(); if (!token) throw new Error('로그인 만료');
            const res = await fetch(`${SVR_JUNGSI}/jungsi/counseling/wishlist/${studentId}/${year}`, {
                headers:{ 'Authorization':`Bearer ${token}` }
            });
            if (res.status===401||res.status===403) { handleAuthError(); return; }
            const data = await res.json();
            if (!data.success) {
                showToast('저장된 상담 없음', false);
                return;
            }
            studentWishlist = data.wishlist || [];
            for (const item of studentWishlist) {
                const gunId = getGunSectionId(item.모집군);
                const container = document.getElementById(gunId)?.querySelector('.result-cards-container');
                if (!container) continue;
                const formula = await fetchFormulaDetails(item.대학학과_ID, year);
                if (!formula) continue;
                const suneungScore = await calculateSuneung(selectedStudentData, item.대학학과_ID, year);
                const card = createResultCard(container, formula, suneungScore, item);
                updateGunCount(gunId);
                // 여기서도 같은 함수로 컷 표시
                fetchAndDisplayDeptStats(card, item.대학학과_ID, year);
            }
            showToast('상담 목록 불러옴');
        } catch (e) {
            console.error(e);
            showToast('상담 목록 로딩 실패', false);
            if (e.message==='로그인 만료') handleAuthError();
        }
    };

    /* =========================
       10. 학생 선택/학년도 변경
    ========================== */
    studentSelect.addEventListener('change', async (e)=>{
        const id = e.target.value;
        
        // --- [MODIFIED] Handle empty state ---
        const emptyState = document.getElementById('empty-state-message');
        const gunSections = document.querySelectorAll('.gun-section');
        
        if (!id) {
            selectedStudentData = null;
            resetResultArea();
            updateStudentInfoCard(null);
            renderFilteredResults(); // This will hide the results table
            
            emptyState.style.display = 'block';
            gunSections.forEach(sec => sec.style.display = 'none');
            return;
        }
        
        // Student is selected
        emptyState.style.display = 'none';
        gunSections.forEach(sec => sec.style.display = 'block');
        // --- [END MODIFICATION] ---
        
        selectedStudentData = allStudents.find(s=>s.student_id==id);
        updateStudentInfoCard(selectedStudentData);
        await loadWishlist();
        renderFilteredResults();
    });

    yearSelect.addEventListener('change', async ()=>{
        selectedStudentData = null;
        studentSelect.value='';
        resetResultArea();
        updateStudentInfoCard(null);

        // [NEW] Also hide gun sections and show empty state on year change
        document.getElementById('empty-state-message').style.display = 'block';
        document.querySelectorAll('.gun-section').forEach(sec => sec.style.display = 'none');
        
        await loadStudents();
        await loadFilterData();
    });

    // [MODIFIED] Hoisting fix: Use function declaration
    function updateStudentInfoCard(std) {
        if (!std) {
            studentInfoContainer.style.display='none';
            return;
        }
        studentInfoContainer.style.display='block';
        studentInfoContainer.querySelector('#selected-student-name').textContent = std.student_name || '-';
        studentInfoContainer.querySelector('#selected-school-name').textContent = std.school_name || '정보없음';
        studentInfoContainer.querySelector('#selected-gender').textContent = std.gender || '-';
        const sc = std.scores || {};
        const format = (label, objName, subject, stdv, pct, grd) => {
            const parts=[];
            if (stdv!=null) parts.push(`표 ${stdv}`);
            if (pct!=null) parts.push(`백 ${pct}`);
            if (grd!=null) parts.push(`<strong class="grade-emphasis">${grd}</strong>등급`);
            return `${label}(${subject||'?' }): ${parts.length?parts.join(' / '):'-'}`;
        };
        studentInfoContainer.querySelector('#score-kor').innerHTML = format('국어', null, sc.국어_선택과목, sc.국어_표준점수, sc.국어_백분위, sc.국어_등급);
        studentInfoContainer.querySelector('#score-math').innerHTML = format('수학', null, sc.수학_선택과목, sc.수학_표준점수, sc.수학_백분위, sc.수학_등급);
        studentInfoContainer.querySelector('#score-eng').innerHTML = `영어: ${sc.영어_등급!=null?`<strong class="grade-emphasis">${sc.영어_등급}</strong>등급`:'-'}`;
        studentInfoContainer.querySelector('#score-hist').innerHTML = `한국사: ${sc.한국사_등급!=null?`<strong class="grade-emphasis">${sc.한국사_등급}</strong>등급`:'-'}`;
        studentInfoContainer.querySelector('#score-inq1').innerHTML = format('탐구1', null, sc.탐구1_선택과목, sc.탐구1_표준점수, sc.탐구1_백분위, sc.탐구1_등급);
        studentInfoContainer.querySelector('#score-inq2').innerHTML = format('탐구2', null, sc.탐구2_선택과목, sc.탐구2_표준점수, sc.탐구2_백분위, sc.탐구2_등급);
    };

    /* =========================
       11. 모달 닫기
    ========================== */
    window.closeModal = (id) => {
        const m = document.getElementById(id);
        if (m) m.style.display='none';
    };
    window.onclick = (e) => {
        if (e.target===crossGunModal) closeModal('cross-gun-modal');
        if (e.target===scoreTableModal) closeModal('score-table-modal');
    };

    /* =========================
       초기 실행
    ========================== */
    loadStudents();
    loadFilterData();
});
</script>
</body>
</html>
